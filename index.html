<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" href="https://static.vecteezy.com/ti/vecteur-libre/p1/22395051-voyage-agence-vecteur-logo-modele-vacances-logo-modele-globe-en-voyageant-logo-vecteur-conception-vectoriel.jpg">
<title>Mes vacances</title>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<style>
  /* (Ton CSS existant, sans changement) */
  html,body,#root { height:100%; margin:0; padding:0; }
  body{
    background: url('./GLOBE/starfield.jpg') no-repeat center center fixed;
    background-size: cover;
    font-family: Inter, Arial, sans-serif;
  }
  #root { position:relative; width:100%; height:100%; overflow:hidden; }
  #globeContainer { width:100%; height:100%; }
  /* Toggle jour/nuit */
  #toggle { position:absolute; top:14px; left:14px; width:100px; height:40px; border-radius:22px; display:flex; align-items:center; justify-content:space-between; padding:4px 8px; cursor:pointer; z-index:120; user-select:none; background: linear-gradient(90deg,#ffe066 50%, #4a90e2 50%); box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
  #toggle.night { background: linear-gradient(90deg,#4a90e2 50%, #ffe066 50%); }
  #toggle .ball { position:absolute; top:4px; left:4px; width:32px; height:32px; border-radius:50%; background:#ffd54a; box-shadow:0 6px 16px rgba(255,213,74,0.28); transition:left .28s, background .28s; }
  #toggle.night .ball { left:64px; background:#f1d56d; }
  /* Toggle relief (rond) */
  #toggleRelief { position: absolute; top: 80px; left: 18px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 120; user-select: none; background: rgba(255,255,255,0.9); box-shadow: 0 4px 10px rgba(0,0,0,0.25); transition: background 0.2s, transform 0.15s; }
  #toggleRelief.active { background: rgba(180,255,180,0.9); }
  #toggleRelief:active { transform: scale(0.95); }
  /* Toggle nuages (rond) */
  #toggleClouds { position: absolute; top: 134px; left: 18px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 120; user-select: none; background: rgba(255,255,255,0.9); box-shadow: 0 4px 10px rgba(0,0,0,0.25); transition: background 0.2s, transform 0.15s; }
  #toggleClouds.active { background: rgba(180,220,255,0.9); }
  #toggleClouds:active { transform: scale(0.95); }
  /* Bouton carré fond du jour (en bas à gauche) */
  #toggleDayBase { position: absolute; left: 18px; bottom: 18px; width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 120; user-select: none; background: rgba(255,255,255,0.95); box-shadow: 0 6px 18px rgba(0,0,0,0.25); font-weight: 700; font-size: 12px; text-align: center; line-height: 1.1; }
  #toggleDayBase:active { transform: scale(0.97); }
  /* Légende */
  #legend { position:absolute; top:14px; right:14px; z-index:120; background: rgba(255,255,255,0.92); padding:10px 12px; border-radius:10px; min-width:160px; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
  #legend label { display:flex; align-items:center; gap:10px; font-weight:600; }
  #legend input[type=checkbox] { width:16px; height:16px; }
  /* Lune */
  #moonPreview { position:absolute; bottom:14px; right:14px; width:140px; height:140px; z-index:110; border-radius:50%; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.6); background:black; }
  /* Popup stats */
  #trajetPopup { position:absolute; bottom:20px; left:20px; background:rgba(0,0,0,0.85); color:white; padding:10px 14px; border-radius:8px; font-size:14px; line-height:1.4; max-width:300px; display:none; z-index:200; }
  /* Popup Leaflet plein écran */
  #leafletPopup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 400; }
  #leafletMap { width: 90%; height: 80%; margin: 40px auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
  #leafletClose { position: absolute; top: 20px; right: 20px; background: #fff; border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 18px; font-weight: bold; }
  /* --- Bouton de projection --- */
  #toggleProjection { position: absolute; top: 180px; left: 18px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 120; user-select: none; background: rgba(255,255,255,0.9); box-shadow: 0 4px 10px rgba(0,0,0,0.25); transition: background 0.2s, transform 0.15s; }
  #toggleProjection.active { background: rgba(255, 180, 180, 0.9); }
  #toggleProjection:active { transform: scale(0.95); }
  #toggleProjection:disabled { opacity: 0.5; cursor: not-allowed; background: rgba(200, 200, 200, 0.9) !important; }
  /* --- AJOUT: styles de la liste dépliable des voyages --- */
  #voyagesDetails { margin-top:8px; }
  #voyagesDetails[hidden] { display:none; }
  #voyagesDetails summary { cursor:pointer; font-weight:700; }
  #voyagesList { margin-top:6px; max-height:260px; overflow:auto; padding-left:2px; }
  #voyagesList label { display:flex; align-items:center; gap:8px; font-weight:500; }
</style>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<div id="root">
  <div id="globeContainer" class="echarts-for-globe"></div>
  <!-- Boutons -->
  <div id="toggle" role="button" aria-pressed="false" aria-label="Basculer jour/nuit">
    <svg class="sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" fill="#FFD43B"/></svg>
    <svg class="moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z" fill="#FFDD66"/></svg>
    <div class="ball" aria-hidden="true"></div>
  </div>
  <div id="toggleRelief" role="button" aria-pressed="false" aria-label="Basculer relief">
    <svg viewBox="0 0 24 30">
      <path d="M3 20l5-9 4 7 5-10 5 12z" fill="#444"/>
      <path d="M3 20h18v1H3z" fill="#777"/>
    </svg>
  </div>
  <div id="toggleClouds" role="button" aria-pressed="false" aria-label="Afficher/masquer les nuages" class="">
    <svg viewBox="0 0 24 24" width="22" height="22">
      <path d="M6 19h11a4 4 0 0 0 0-8 5 5 0 0 0-9.8-1.7A4 4 0 0 0 6 19z" fill="#4a90e2"/>
    </svg>
  </div>
  <div id="toggleDayBase" role="button" aria-label="Changer fond du jour" title="Changer fond du jour">EARTH</div>
  <!-- Bouton de projection -->
  <div id="toggleProjection" role="button" aria-pressed="false" aria-label="Basculer globe/carte" disabled>
    <svg viewBox="0 0 24 24" width="22" height="22">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" fill="#4a90e2"/>
      <path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" fill="#4a90e2"/>
    </svg>
  </div>
  <!-- Légende -->
  <div id="legend" role="group" aria-label="Contrôles des couches">
    <label><input id="chkPays" type="checkbox"> Limites (Pays)</label>
    <label><input id="chkTrajets" type="checkbox"> Trajets</label>
    <div id="voyagesList" role="group" aria-label="Liste des voyages" style="display:none; margin-top:6px; max-height:260px; overflow:auto;"></div>
  </div>
  <!-- Lune -->
  <div id="trajetPopup"></div>
</div>
<!-- Popup Leaflet -->
<div id="leafletPopup">
  <div id="leafletMap"></div>
  <button id="leafletClose">X</button>
</div>
<script>
(async function(){
  const PATH_EARTH_DAY_1 = './GLOBE/earth.jpg';
  const PATH_EARTH_DAY_2 = './GLOBE/world.topo.bathy.200401.jpg';
  const CLOUDS = './GLOBE/clouds.png';
  const PATH_EARTH_NIGHT_RAW = './GLOBE/night.jpg';
  const PATH_STARFIELD = './GLOBE/starfield.jpg';
  const PATH_COUNTRIES = './GEOJSON/countries_10m_new.geojson';
  const PATH_TRAJETS = './GEOJSON/TRAJETS_ALL_vacances_wgs.geojson';
  const PATH_EARTH_BUMP = './GLOBE/world.topo.bathy.200401.jpg';

  // Variable pour suivre le chargement de la carte monde
  let isWorldMapLoaded = false;

  // Charge la carte monde pour le mode 2D
  fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
    .then(r => r.json())
    .then(geoJson => {
      echarts.registerMap('world', geoJson);
      isWorldMapLoaded = true;
      document.getElementById('toggleProjection').disabled = false;
      console.log("Carte monde chargée.");
    })
    .catch(e => {
      console.error("Erreur de chargement de la carte monde :", e);
      alert("Impossible de charger la carte monde. Le mode 2D ne sera pas disponible.");
    });

  const loadJSON = url => fetch(url).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
  const loadImage = url => new Promise((res, rej) => { const img = new Image(); img.crossOrigin = 'anonymous'; img.onload = ()=>res(img); img.onerror = rej; img.src = url; });
  const normalizeLng = lng => ((lng + 180) % 360) - 180;

  const linesFromPolygonGeom = geom => {
    const out = [];
    if(!geom) return out;
    if(geom.type === 'Polygon'){
      geom.coordinates.forEach(ring => out.push({ coords: ring.map(([x,y]) => [normalizeLng(x), y, 0.001]) }));
    } else if(geom.type === 'MultiPolygon'){
      geom.coordinates.forEach(poly => poly.forEach(ring => out.push({ coords: ring.map(([x,y]) => [normalizeLng(x), y, 0.001]) })));
    }
    return out;
  };
  const extractLinesFromFeature = feature => {
    const out = [], g = feature && feature.geometry;
    if(!g) return out;
    if(g.type === 'LineString'){
      out.push({ coords: g.coordinates.map(([x,y]) => [normalizeLng(x), y]) });
    } else if(g.type === 'MultiLineString'){
      g.coordinates.forEach(lineCoords => out.push({ coords: lineCoords.map(([x,y]) => [normalizeLng(x), y]) }));
    } else if(g.type === 'Polygon' || g.type === 'MultiPolygon'){
      linesFromPolygonGeom(g).forEach(l => out.push(l));
    }
    return out;
  };
  // texture nuit
  const nightTexture = (await loadImage(PATH_EARTH_NIGHT_RAW)).src;
  // chargement des données
  const [countriesGeo, trajetsGeo] = await Promise.all([
    loadJSON(PATH_COUNTRIES),
    loadJSON(PATH_TRAJETS)
  ]);
  // frontières
  const countryLines = [];
  (countriesGeo.features || []).forEach(f => linesFromPolygonGeom(f.geometry).forEach(l => countryLines.push(l)));
  // trajets + collecte des valeurs uniques de `voyage`
  const trajetLines = [];
  const voyagesSet = new Set();
  const mapColor = { avion:'#00dbc5', train:'#db0016', bus:'#dbc500', voiture:'#0016db', bateau:'#0084db' };
  (trajetsGeo.features || []).forEach(f => {
    const col = mapColor[(f.properties?.trajet || f.properties?.transport || '').toLowerCase()] || '#00ffff';
    const voyageVal = (f.properties?.voyage ?? 'Inconnu');
    voyagesSet.add(voyageVal);
    extractLinesFromFeature(f).forEach(l => trajetLines.push({
      ...l,
      lineStyle:{ color: col, width: 2.5, opacity: 0.95 },
      properties:f.properties,
      voyage: voyageVal
    }));
  });
  // Mapping voyage -> villes
  const voyagesToCities = {
    'May 2025 - China': ['Beijing','Xi\'an','Shanghai','Hangzhou','Guilin','Yangshuo','Tianjin'],
    'July 2025 - Central Europe': ['Munich','Salzburg','Budapest','Prague','Regensburg','Ulm']
  };
  // villes visitées
  const visitedCities = [
    { name: 'Beijing', value: [116.383331, 39.916668, 0], visites: [{ name:'Cité interdite', coords:[116.39082, 39.91691], photo:'citeinterdire.jpg' }, { name:'Palais d été', coords:[116.26793, 39.99761], photo:'palaisdete.jpg' }] },
    { name: 'Xi\'an', value: [108.94243, 34.264533, 0], visites: [{ name:'Armée de terre cuite', coords:[109.2791, 34.3836], photo:'terrecuite.jpg' }] },
    { name: 'Shanghai', value: [121.4737, 31.2304, 0], visites: [{ name:'Bund', coords:[121.490317, 31.241666], photo:'bund.jpg' }, { name:'Yu Garden', coords:[121.4926, 31.2272], photo:'yugarden.jpg' }] },
    { name: 'Hangzhou', value: [120.17478, 30.27338, 0], visites: [{ name:'Lac de l\'Ouest', coords:[120.1536, 30.2495], photo:'lacouest.jpg' }] },
    { name: 'Guilin', value: [110.28782, 25.27805, 0], visites: [{ name:'Colline de la Trompe d\'éléphant', coords:[110.2991, 25.2636], photo:'elephant.jpg' }] },
    { name: 'Yangshuo', value: [110.486715, 24.7791743, 0], visites: [{ name:'Rivière Li', coords:[110.4938, 24.7766], photo:'riviereli.jpg' }] },
    { name: 'Tianjin', value: [117.18850, 39.13867, 0], visites: [{ name:'Temple de la Grande Bénédiction', coords:[117.1875, 39.1381], photo:'temple.jpg' }] },
    { name: 'Munich', value: [11.57251, 48.13922, 0], visites: [{ name:'Marienplatz', coords:[11.5761, 48.1374], photo:'marienplatz.jpg' }] },
    { name: 'Marquartstein', value: [12.46238, 47.75929, 0], visites: [{ name:'Château de Marquartstein', coords:[12.4624, 47.7593], photo:'chateau.jpg' }] },
    { name: 'Salzburg', value: [13.04159, 47.80523, 0], visites: [{ name:'Forteresse Hohensalzburg', coords:[13.0550, 47.7965], photo:'hohensalzburg.jpg' }] },
    { name: 'Budapest', value: [19.05196, 47.49394, 0], visites: [{ name:'Parlement hongrois', coords:[19.0555, 47.5079], photo:'parlement.jpg' }] },
    { name: 'Prague', value: [14.42037, 50.08427, 0], visites: [{ name:'Pont Charles', coords:[14.4119, 50.0869], photo:'pontcharles.jpg' }] },
    { name: 'Regensburg', value: [12.09421, 49.02009, 0], visites: [{ name:'Cathédrale Saint-Pierre', coords:[12.0983, 49.0195], photo:'cathedrale.jpg' }] },
    { name: 'Ulm', value: [9.99271, 48.39848, 0], visites: [{ name:'Cathédrale d\'Ulm', coords:[9.9917, 48.3985], photo:'cathedraleulm.jpg' }] }
  ];

  const globeChart = echarts.init(document.getElementById('globeContainer'), null, { renderer:'webgl' });

  let state = {
    showPays: false,
    showTrajets: false,
    showNuages: false,
    isNight: false,
    showRelief: false,
    dayBase: 'earth',
    activeVoyages: new Set(voyagesSet),
    isGlobe: true // Mode par défaut : Globe
  };

  function makeOption(s) {
    const series = [];

    // --- Frontières des pays ---
    if (s.showPays) {
      series.push({
        name: 'Pays',
        type: s.isGlobe ? 'lines3D' : 'lines',
        coordinateSystem: s.isGlobe ? 'globe' : 'geo',
        polyline: true,
        data: countryLines,
        lineStyle: { color: '#f0f0f0', width: 1, opacity: 0.98 }
      });
    }

    // --- Trajets filtrés par voyages ---
    if (s.showTrajets) {
      const filteredTrajets = trajetLines.filter(l => s.activeVoyages.has(l.voyage));
      series.push({
        name: 'Trajets',
        type: s.isGlobe ? 'lines3D' : 'lines',
        coordinateSystem: s.isGlobe ? 'globe' : 'geo',
        polyline: true,
        data: filteredTrajets,
        effect: s.isGlobe ? {
          show: true,
          period: 10,
          constantSpeed: 5,
          trailLength: 0.15,
          symbolSize: 6,
          color: '#FFFFFF',
        } : { show: false },
        lineStyle: {
          width: 2.5,
          opacity: 0.95,
        }
      });
    }

    // --- Pins des villes visitées (filtrées par voyages) ---
    let pinsData = [];
    const allowedCities = new Set();
    if (s.activeVoyages && s.activeVoyages.size) {
      s.activeVoyages.forEach(v => {
        const list = voyagesToCities[v];
        if (Array.isArray(list)) list.forEach(city => allowedCities.add(city));
      });
    }
    if (allowedCities.size > 0) {
      pinsData = visitedCities.filter(c => allowedCities.has(c.name));
    } else {
      pinsData = [];
    }
    series.push({
      name: 'Pins',
      type: s.isGlobe ? 'scatter3D' : 'scatter',
      coordinateSystem: s.isGlobe ? 'globe' : 'geo',
      symbol: 'circle',
      symbolSize: 10,
      itemStyle: {
        color: '#FFFFFF',
        borderColor: '#000000',
        borderWidth: 0.75,
      },
      emphasis: {
        itemStyle: {
          color: '#FFD700',
          borderColor: '#000000',
          borderWidth: 1,
        },
        label: {
          show: true,
          formatter: p => p.name,
          position: 'top',
          textStyle: {
            color: '#fff',
            backgroundColor: 'rgba(0,0,0,1)',
            fontSize: 15,
            padding: [2, 2],
            borderRadius: 3
          }
        }
      },
      data: pinsData
    });

    // --- Configuration de la projection ---
    const layers = [];
    if (!s.isNight) {
      layers.push({
        show: true,
        name: 'Ombre nuit',
        type: 'blend',
        intensity: 1,
        blendTo: 'emission',
        texture: PATH_EARTH_NIGHT_RAW
      });
    }
    if (s.isNight) {
      layers.push({
        show: true,
        name: 'Ombre nuit',
        type: 'blend',
        intensity: 1.3,
        blendTo: 'emission',
        texture: PATH_EARTH_NIGHT_RAW
      });
    }
    if (s.showNuages) {
      layers.push({
        show: true,
        name: 'Nuages',
        type: 'overlay',
        texture: CLOUDS,
        shading: 'lambert',
        distance: 1
      });
    }

    // --- Options spécifiques au mode Globe ou Carte 2D ---
    const baseDay = (s.dayBase === 'earth') ? PATH_EARTH_DAY_1 : PATH_EARTH_DAY_2;
    const projectionOptions = s.isGlobe ? {
      globe: {
        baseTexture: s.isNight ? nightTexture : baseDay,
        heightTexture: s.showRelief ? PATH_EARTH_BUMP : undefined,
        displacementScale: 0.025,
        shading: s.isNight ? 'lambert' : 'realistic',
        environment: PATH_STARFIELD,
        postEffect: { enable: false },
        light: {
          ambient: { color: '#1f1f1f', intensity: 0.2 },
          main: { color: '#FFFDED', intensity: s.isNight ? -20 : 0.9 }
        },
        atmosphere: { show: true, color: '#a1a1a1', offset: 4 },
        viewControl: {
          autoRotate: false,
          autoRotateSpeed: 0.5,
          animation: true,
          animationDurationUpdate: 1000
        },
        layers
      }
    } : {
      geo: {
        map: 'world',
        roam: true,
        emphasis: {
          label: { show: false },
          itemStyle: { areaColor: '#f0f0f0' }
        },
        regions: [{
          name: 'World',
          itemStyle: {
            areaColor: s.isNight ? '#111' : '#eee',
            borderColor: '#444',
            borderWidth: 0.5
          }
        }]
      }
    };

    // --- Retour de la configuration ---
    return {
      backgroundColor: 'transparent',
      ...projectionOptions,
      series
    };
  }

  function getCurrentView() {
    const opt = globeChart.getOption();
    if (opt && opt.globe && opt.globe[0] && opt.globe[0].viewControl) {
      return { ...opt.globe[0].viewControl };
    }
    return null;
  }

  function refresh() {
    const currentView = getCurrentView();
    const newOpt = makeOption(state);
    if (currentView && newOpt.globe) {
      newOpt.globe.viewControl = { ...newOpt.globe.viewControl, ...currentView };
    }
    globeChart.setOption(newOpt, { notMerge: true });
  }

  // --- UI refs ---
  const toggleEl = document.getElementById('toggle');
  const toggleReliefEl = document.getElementById('toggleRelief');
  const toggleCloudsEl = document.getElementById('toggleClouds');
  const toggleDayBaseEl = document.getElementById('toggleDayBase');
  const toggleProjectionEl = document.getElementById('toggleProjection');
  const chkPays = document.getElementById('chkPays');
  const chkTrajets = document.getElementById('chkTrajets');
  const popupEl = document.getElementById('trajetPopup');
  const leafletPopupEl = document.getElementById('leafletPopup');
  const leafletMapEl = document.getElementById('leafletMap');
  const leafletCloseBtn = document.getElementById('leafletClose');
  const voyagesListEl = document.getElementById('voyagesList');

  // Remplit la liste avec les valeurs uniques de `voyage`
  Array.from(voyagesSet).sort().forEach(v => {
    const id = 'voy_'+v.replace(/[^A-Za-z0-9_-]/g,'_');
    const label = document.createElement('label');
    label.setAttribute('for', id);
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = id;
    cb.className = 'voyageChk';
    cb.value = v;
    cb.checked = true;
    cb.setAttribute('aria-label', 'Voyage '+v);
    label.appendChild(cb);
    label.appendChild(document.createTextNode(' '+v));
    voyagesListEl.appendChild(label);
  });

  // --- Événements ---
  toggleEl.addEventListener('click', ()=>{
    state.isNight = !state.isNight;
    toggleEl.classList.toggle('night', state.isNight);
    toggleEl.setAttribute('aria-pressed', String(state.isNight));
    refresh();
  });

  toggleReliefEl.addEventListener('click', ()=>{
    state.showRelief = !state.showRelief;
    toggleReliefEl.classList.toggle('active', state.showRelief);
    toggleReliefEl.setAttribute('aria-pressed', String(state.showRelief));
    refresh();
  });

  toggleCloudsEl.addEventListener('click', ()=>{
    state.showNuages = !state.showNuages;
    toggleCloudsEl.classList.toggle('active', state.showNuages);
    toggleCloudsEl.setAttribute('aria-pressed', String(state.showNuages));
    refresh();
  });

  function updateDayBaseButtonLabel() {
    toggleDayBaseEl.textContent = (state.dayBase === 'earth') ? 'EARTH' : 'TOPO';
  }

  toggleDayBaseEl.addEventListener('click', ()=>{
    state.dayBase = (state.dayBase === 'earth') ? 'topo' : 'earth';
    updateDayBaseButtonLabel();
    refresh();
  });

  updateDayBaseButtonLabel();

  [['Pays', chkPays], ['Trajets', chkTrajets]].forEach(([name, el])=>{
    el.addEventListener('change', e=>{
      state['show'+name] = e.target.checked;
      if (name === 'Trajets') {
        voyagesListEl.style.display = state.showTrajets ? 'block' : 'none';
      }
      refresh();
    });
  });

  // Gestion des cases des voyages
  voyagesListEl.addEventListener('change', (e)=>{
    const t = e.target;
    if (t && t.classList.contains('voyageChk')) {
      if (t.checked) state.activeVoyages.add(t.value);
      else state.activeVoyages.delete(t.value);
      refresh();
    }
  });

  // Écouteur pour le bouton de projection
  toggleProjectionEl.addEventListener('click', () => {
    if (!isWorldMapLoaded && !state.isGlobe) {
      alert("La carte monde est en cours de chargement. Le mode 2D sera disponible bientôt.");
      return;
    }
    state.isGlobe = !state.isGlobe;
    toggleProjectionEl.classList.toggle('active', !state.isGlobe);
    refresh();
  });

  // Leaflet popup helpers (inchangé)
  let currentLeafletMap = null;
  function openLeafletPopup(cityData) {
    leafletPopupEl.style.display = 'block';
    if (currentLeafletMap) {
      currentLeafletMap.remove();
      currentLeafletMap = null;
    }
    leafletMapEl.innerHTML = '';
    const [lon, lat] = cityData.value;
    currentLeafletMap = L.map(leafletMapEl).setView([lat, lon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(currentLeafletMap);
    (cityData.visites || []).forEach(v => {
      const [vlon, vlat] = v.coords;
      L.marker([vlat, vlon]).addTo(currentLeafletMap)
        .bindPopup(`<b>${v.name || ''}</b><br>${v.photo ? `<img src="${v.photo}" width="180"/>` : ''}`);
    });
    setTimeout(()=>{ currentLeafletMap.invalidateSize(); }, 50);
  }

  function closeLeafletPopup() {
    leafletPopupEl.style.display = 'none';
    if (currentLeafletMap) { currentLeafletMap.remove(); currentLeafletMap = null; }
  }

  leafletCloseBtn.addEventListener('click', closeLeafletPopup);
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeLeafletPopup(); });
  leafletPopupEl.addEventListener('click', (e)=>{ if (e.target === leafletPopupEl) closeLeafletPopup(); });

  // Clic sur globe
  globeChart.on('click', params => {
    if (params.seriesName === 'Trajets' && params.data && params.data.properties) {
      const p = params.data.properties;
      popupEl.innerHTML = `
        <strong>Trajet:</strong> ${p.trajet || ''}<br/>
        <strong>Voyage:</strong> ${p.voyage || ''}<br/>
        <strong>Date début:</strong> ${p.date_deb || ''}<br/>
        <strong>Date fin:</strong> ${p.date_fin || ''}<br/>
        <strong>Durée:</strong> ${p.duree || ''}<br/>
        <strong>Distance:</strong> ${p.distanceKM || ''} km
      `;
      popupEl.style.display = 'block';
    } else if (params.seriesName === 'Pins' && params.data) {
      popupEl.style.display = 'none';
      openLeafletPopup(params.data);
    } else {
      popupEl.style.display = 'none';
    }
  });

  // Rendu initial
  voyagesListEl.style.display = state.showTrajets ? 'block' : 'none';
  refresh();
})();
</script>
</body>
</html>
