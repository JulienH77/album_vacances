<!doctype html>
<html lang="fr">
<head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width,initial-scale=1"/>
      <link rel="icon" href="./GLOBE/icone_onglet.png">
      <title>Mes vacances</title>
      <link rel="stylesheet" href="styles.css">
      /*GEOJSON use*/
      <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
      /* ECHART use*/
      <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
      /*LEAFLET use*/
      <!--<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
      <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="">
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
      /*Sidepanel leaflet*/
      <link rel="stylesheet" href="leaflet-sidepanel.css" />
      <script src="leaflet-sidepanel.min.js"></script>
      /*OSMBuilding 3D*/
      <script src="https://cdn.osmbuildings.org/classic/0.2.2b/OSMBuildings-Leaflet.js"></script>
	<style>
		.voyages-container {
		  margin-top: 8px;
		  padding-top: 6px;
		  border-top: 1px solid #ccc;
		}
		.voyages-container strong {
		  display: block;
		  margin-bottom: 4px;
		}
		.voyages-container label {
		  font-weight: normal;
		}
		/* Fl√®ches de direction des photos */
		.arrow-icon {
		  font-size: 18px;
		  font-weight: bold;
		  color: red;
		  text-shadow: 0 0 3px white;
		}
		.arrow {
		  display: inline-block;
		  transition: transform 0.2s linear;
		  margin-left: 5px;
		}
	</style>
</head>
<body>
      <div id="root">
		    <!-- Nouvelle carte Leaflet principale -->
  			<div id="mainMap"></div>
		  
		    <!-- Bouton pour ouvrir la bobine -->
            <div id="toggleReel">^</div>
            <!-- Bobine horizontale -->
            <div id="cityReel"></div>
      </div>
	
	  <div id="globePopup">
	    <button id="globeClose">X</button>
		            <div id="globeContainer" class="echarts-for-globe"></div>
            <!-- Buttons -->
            <!-- night -->
            <div id="toggleNight" class="toggle-btn" role="button" aria-pressed="false" aria-label="Basculer ombre de nuit">
                <svg viewBox="0 0 24 24" width="22" height="22">
                    <path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z" fill="#FFDD66"/>
                </svg>
            </div>
            <!-- relief -->
            <div id="toggleRelief" class="toggle-btn" role="button" aria-pressed="false" aria-label="Basculer relief">
                <svg viewBox="0 0 24 30">
                    <path d="M3 20l5-9 4 7 5-10 5 12z" fill="#444"/>
                    <path d="M3 20h18v1H3z" fill="#777"/>
                </svg>
            </div>
            <!-- clouds -->
            <div id="toggleClouds" class="toggle-btn" role="button" aria-pressed="false" aria-label="Afficher/masquer les nuages">
                <svg viewBox="0 0 24 24" width="22" height="22">
                    <path d="M6 19h11a4 4 0 0 0 0-8 5 5 0 0 0-9.8-1.7A4 4 0 0 0 6 19z" fill="#4a90e2"/>
                </svg>
            </div>
            <!-- Basemap -->
            <div id="toggleDayBase" role="button" aria-label="Changer fond du jour" title="Changer fond du jour">EARTH</div>
            <!-- Legend -->
            <div id="legend" role="group" aria-label="Contr√¥les des couches">
                <label><input id="chkPays" type="checkbox"> Limites (Pays)</label>
                <label><input id="chkTrajets" type="checkbox"> Trajets</label>
                <!-- AJOUT : liste des voyages directement sous "Trajets" -->
                <div id="voyagesList" role="group" aria-label="Liste des voyages" style="display:none; margin-top:6px; max-height:260px; overflow:auto;"></div>         
            </div>
            <div id="trajetLegend" style="position:absolute; bottom:30px; right:20px; background:white; padding:8px 12px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.3); font-size:14px; display:none;">
                <strong style="display:block; margin-bottom:6px;">L√©gende trajets</strong>
            </div>   
            <!-- A QUOI SERS TU ? -->
            <div id="trajetPopup"></div>
		</div>


	<!-- CA MARCHE ENCORE ???? -->
      <!-- Popup Leaflet -->
      <div id="leafletPopup">
            <div id="leafletMap" class="leaflet-container leaflet-touch leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0" style="position: relative;"></div> 
            <button id="leafletClose">X</button>
            <!-- Popup d'agrandissement de photo -->
            <div id="photoPopup" style="display: none;">
                    <img id="photoPopupImg" src="" alt="Photo agrandie">
                    <button id="photoClose">X</button>
            </div>
      </div>

			<!-- Side Panel left -->
		<div id="mySidepanelLeft" class="sidepanel sidepanel-left tabs-left opened" aria-label="side panel" aria-hidden="false">
			<div class="sidepanel-inner-wrapper">
				<nav class="sidepanel-tabs-wrapper" aria-label="sidepanel tab navigation">
					<ul class="sidepanel-tabs">
						<li class="sidepanel-tab">
							<a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-1">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
									<path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"></path>
								</svg>
							</a>
						</li>
						<li class="sidepanel-tab">
							<a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-2">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-geo" viewBox="0 0 16 16">
									<path fill-rule="evenodd" d="M8 1a3 3 0 1 0 0 6 3 3 0 0 0 0-6zM4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999zm2.493 8.574a.5.5 0 0 1-.411.575c-.712.118-1.28.295-1.655.493a1.319 1.319 0 0 0-.37.265.301.301 0 0 0-.057.09V14l.002.008a.147.147 0 0 0 .016.033.617.617 0 0 0 .145.15c.165.13.435.27.813.395.751.25 1.82.414 3.024.414s2.273-.163 3.024-.414c.378-.126.648-.265.813-.395a.619.619 0 0 0 .146-.15.148.148 0 0 0 .015-.033L12 14v-.004a.301.301 0 0 0-.057-.09 1.318 1.318 0 0 0-.37-.264c-.376-.198-.943-.375-1.655-.493a.5.5 0 1 1 .164-.986c.77.127 1.452.328 1.957.594C12.5 13 13 13.4 13 14c0 .426-.26.752-.544.977-.29.228-.68.413-1.116.558-.878.293-2.059.465-3.34.465-1.281 0-2.462-.172-3.34-.465-.436-.145-.826-.33-1.116-.558C3.26 14.752 3 14.426 3 14c0-.599.5-1 .961-1.243.505-.266 1.187-.467 1.957-.594a.5.5 0 0 1 .575.411z"></path>
								</svg>
							</a>
						</li>
						<li class="sidepanel-tab">
							<a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-3">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-geo-alt" viewBox="0 0 16 16">
									<path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z"></path>
									<path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
								</svg>
							</a>
						</li>
						<li class="sidepanel-tab">
							<a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-4">
								<!--<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-bookmarks" viewBox="0 0 16 16">
									<path d="M2 4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v11.5a.5.5 0 0 1-.777.416L7 13.101l-4.223 2.815A.5.5 0 0 1 2 15.5V4zm2-1a1 1 0 0 0-1 1v10.566l3.723-2.482a.5.5 0 0 1 .554 0L11 14.566V4a1 1 0 0 0-1-1H4z"></path>
									<path d="M4.268 1H12a1 1 0 0 1 1 1v11.768l.223.148A.5.5 0 0 0 14 13.5V2a2 2 0 0 0-2-2H6a2 2 0 0 0-1.732 1z"></path>
								</svg>-->
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
								    <circle cx="12" cy="12" r="10" stroke-linecap="round" stroke-linejoin="round"/>
								    <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20z" stroke-linecap="round" stroke-linejoin="round"/>
								    <path d="M2 12h20" stroke-linecap="round" stroke-linejoin="round"/>
								    <path d="M12 2v20" stroke-linecap="round" stroke-linejoin="round"/>
								</svg>

							</a>
						</li>
						<li class="sidepanel-tab">
							<a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-5">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
									<path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"></path>
									<path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"></path>
								</svg>
							</a>
						</li>
					</ul>
				</nav>
				<div class="sidepanel-content-wrapper">
					<div class="sidepanel-content">
						<div class="sidepanel-tab-content" data-tab-content="tab-1">
							<h4 data-lang-text="FR:Mes vacances;EN:My holidays;CH:ÊàëÁöÑÂÅáÊúü"></h4>
							<p data-lang-text="FR:Ce site me sert d'album photo pour mes vacances √† partir de mon voyage en Chine en Mai 2025. Je compte bien le remplir et y prendre un grand plaisir √† d√©velopper l'enti√®ret√© du site en repoussant mes limites en code.;EN:This website serves as my photo album for my vacation, starting with my trip to China in May 2025. I plan to fill it with photos and have a lot of fun developing the entire site, pushing my coding skills to new limits.;CH:ÈÄôÂÄãÁ∂≤Á´ôÊòØÊàëÁöÑÂÅáÊúüÁõ∏ÂÜäÔºåÂæûÊàë2025Âπ¥5ÊúàÁöÑ‰∏≠Âúã‰πãÊóÖÈñãÂßã„ÄÇÊàëË®àÂäÉÊääÂÆÉÂ°´ÊªøÔºå‰∏¶ÈùûÂ∏∏Ê®ÇÊÑèÈÄèÈÅéÁ™ÅÁ†¥ÊàëÁöÑÁ∑®Á¢ºÊ•µÈôê‰æÜÈñãÁôºÊï¥ÂÄãÁ∂≤Á´ô„ÄÇ"></p><br>
							<p data-lang-text="FR:Le deuxi√®me onglet contient la liste de toutes les villes que j'ai visit√©es. Il est possible de cliquer sur chacune d'entre elles.;EN:The second tab contains a list of all the cities I have visited. You can click on any of them.;CH:Á¨¨‰∫åÂÄãÊ®ôÁ±§È†ÅÂàóÂá∫‰∫ÜÊàëÂéªÈÅéÁöÑÊâÄÊúâÂüéÂ∏Ç„ÄÇ‰Ω†ÂèØ‰ª•ÈªûÊìäÊØèÂÄãÂüéÂ∏Ç„ÄÇ"></p><br>
							<p data-lang-text="FR:Le troisi√®me onglet sert de phototh√®que, apr√®s avoir cliqu√© sur une des villes dans la liste, les photos de celle-ci y apparaitront dans l'ordre chronologique et sont aussi cliquables.;EN:The third tab serves as a photo gallery; after clicking on one of the cities in the list, the photos for that city will appear there in chronological order, and they are also clickable.;CH:Á¨¨‰∏âÂÄãÊ®ôÁ±§ÊòØÁÖßÁâáÂ∫´ÔºåÈªûÊìäÊ∏ÖÂñÆ‰∏≠ÁöÑÊüêÂÄãÂüéÂ∏ÇÂæåÔºåË©≤ÂüéÂ∏ÇÁöÑÁÖßÁâáÊúÉÊåâÊôÇÈñìÈ†ÜÂ∫èÂá∫ÁèæÔºå‰∏¶‰∏îÂèØ‰ª•ÈªûÊìä„ÄÇ"></p><br>
							<p data-lang-text="FR:Le quatri√®me onglet contient le globe terrestre avec les trajets et villes visit√©es aussi.;EN:The fourth tab contains a globe showing the routes and cities visited.;CH:Á¨¨ÂõõÂÄãÊ®ôÁ±§ÂåÖÂê´Âú∞ÁêÉÂÑÄ‰ª•ÂèäÊâÄÈÄ†Ë®™ÁöÑË∑ØÁ∑öÂíåÂüéÂ∏Ç„ÄÇ"></p><br>
							<p data-lang-text="FR:Le dernier onglet contiendra des param√®tres √† modifier en fonction de l'utilisateur.;EN:The last tab will contain settings that can be modified according to the user's preferences.;CH:ÊúÄÂæå‰∏ÄÂÄãÈÅ∏È†ÖÂç°Â∞áÂåÖÂê´Ê†πÊìö‰ΩøÁî®ËÄÖÈúÄÊ±Ç‰øÆÊîπÁöÑË®≠ÂÆö„ÄÇ"></p>
							<br><br>
							<p data-lang-text="FR:Bonne d√©couverte de mes diff√©rentes vacances !;EN:Enjoy discovering my various vacation experiences!;CH:‰∫´ÂèóÊé¢Á¥¢Êàë‰∏çÂêåÁöÑÂÅáÊúü"></p>
						</div>
						<div class="sidepanel-tab-content" data-tab-content="tab-2">
							<h4 data-lang-text="FR:Les villes du monde que j'ai visit√©es;EN:The cities around the world that I have visited;CH:ÊàëÂéªÈÅéÁöÑ‰∏ñÁïåÂêÑÂú∞ÁöÑÂüéÂ∏Ç"></h4>
							<div class="city-list">
							  <button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/Beijing.jpg');">
							    <span>Beijing</span>
							  </button>
							  <button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/xian.jpg');">
							    <span>Xi'an</span>
							  </button>
							  <button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/shanghai.jpg');">
							    <span>Shanghai</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/hangzhou.jpg');">
							    <span>Hangzhou</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/guilin.jpg');">
							    <span>Guilin</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/yangshuo.jpg');">
							    <span>Yangshuo</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/tianjin.jpg');">
							    <span>Tianjin</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/munich.png');">
							    <span>Munich</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/marquartstein.jpg');">
							    <span>Marquartstein</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/salzburg.jpg');">
							    <span>Salzburg</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/budapest.jpg');">
							    <span>Budapest</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/prague.jpg');">
							    <span>Prague</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/regensburg.jpg');">
							    <span>Regensburg</span>
							  </button>
								<button class="city-btn" style="background-image: url('./GLOBE/ImgVillesVisitees/Ulm.jpg');">
							    <span>Ulm</span>
							  </button>
							</div>
						</div>
						<div class="sidepanel-tab-content" data-tab-content="tab-3">
						</div>
						<div class="sidepanel-tab-content" data-tab-content="tab-4">
						  <h4 data-lang-text="FR:Globe 3D;EN:3D globe;CH:3DÂú∞ÁêÉÂÑÄ"></h4>
						  <button id="toggleGlobeBtn"><span data-lang-text="FR:Afficher le Globe;EN:Show the Globe;CH:Â±ïÁ§∫Âú∞ÁêÉÂÑÄ"></span></button>
						</div>
						<div class="sidepanel-tab-content" data-tab-content="tab-5">
						    <h4 data-lang-text="FR:Param√®tres;EN:Settings;CH:Ë®≠ÂÆö"></h4>
						    <hr class="divider">
						    <div class="setting-item">
						        <label class="switch">
						            <input type="checkbox" id="toggleDirections">
						            <span class="slider"></span>
						        </label>
						        <span style="margin-left:10px;" data-lang-text="FR:Afficher la direction des photos;EN:Show the photo directions;CH:È°ØÁ§∫ÁÖßÁâáÊñπÂêë"></span>
						    </div>
						    <hr class="divider">
						    <p class="language-label" data-lang-text="FR:Choix de la langue;EN:Language choice;CH:Ë™ûË®ÄÈÅ∏Êìá"></p>
						
						    <div class="language-selector">
						        <button class="language-option active" data-lang="FR">FR</button>
						        <button class="language-option" data-lang="EN">EN</button>
						        <button class="language-option" data-lang="CH">CH</button>
						    </div>
						</div>
					</div>
				</div>
			</div>
			<div class="sidepanel-toggle-container">
				<button class="sidepanel-toggle-button" type="button" aria-label="toggle side panel"></button>
			</div>
		</div>

      
// villes visit√©es avec photos et coordonn√©es
<script src="visitedCities.js"></script> 
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Langue par d√©faut
	let directionsLayer;  // calque pour stocker les fl√®ches
    let currentLanguage = 'FR';

    // Fonction pour obtenir la traduction d'un objet GeoJSON
    function getTranslatedName(item, lang) {
        if (item.name && item.name[lang]) {
            return item.name[lang];
        }
        // Retourne le nom par d√©faut (FR) si la traduction n'existe pas
        return item.name ? item.name.FR || item.name.EN || item.name : '';
    }

    // Fonction pour changer la langue dans l'interface
    function changeLanguage(lang) {
        currentLanguage = lang;

        // Mettre √† jour l'√©tat "active" des boutons de langue
        document.querySelectorAll('.language-option').forEach(button => {
            button.classList.remove('active');
            if (button.getAttribute('data-lang') === lang) {
                button.classList.add('active');
            }
        });

        // Mettre √† jour les textes statiques (HTML)
        document.querySelectorAll('[data-lang-text]').forEach(element => {
            const translations = element.getAttribute('data-lang-text').split(';');
            let textForLang = '';
            translations.forEach(translation => {
                const [langCode, text] = translation.split(':');
                if (langCode === lang) {
                    textForLang = text;
                }
            });
            if (textForLang) {
                element.textContent = textForLang;
            }
        });

        // Mettre √† jour les noms dynamiques (GeoJSON) si n√©cessaire
        // Exemple : si tu as une liste ou des popups √† mettre √† jour
        updateDynamicNames(lang);
    }

    // Fonction pour mettre √† jour les noms dynamiques (ex: popups Leaflet, listes, etc.)
    function updateDynamicNames(lang) {
        // Exemple : Parcours tes donn√©es GeoJSON et mets √† jour les √©l√©ments affich√©s
        // Remplace `visites` par ton tableau de donn√©es GeoJSON
        if (typeof visites !== 'undefined') {
            visites.forEach(visite => {
                if (visite.marker && visite.marker.getPopup) {
                    const popup = visite.marker.getPopup();
                    const translatedName = getTranslatedName(visite, lang);
                    popup.setContent(translatedName);
                }
                // Ajoute ici d'autres mises √† jour pour listes, infobulles, etc.
            });
        }
    }
    // √âcouter les clics sur les boutons de langue
    document.querySelectorAll('.language-option').forEach(button => {
        button.addEventListener('click', function() {
            const lang = this.getAttribute('data-lang');
            changeLanguage(lang);
        });
    });
    // Initialisation : appliquer la langue par d√©faut au chargement
    changeLanguage(currentLanguage);
});


(async function(){
	
  /* Les variables */
  const PATH_EARTH_DAY_1 = './GLOBE/earth.jpg';
  const PATH_EARTH_DAY_2 = './GLOBE/world.topo.bathy.200401.jpg';
  const CLOUDS = 'https://clouds.matteason.co.uk/images/4096x2048/clouds-alpha.png';
  const PATH_EARTH_NIGHT_RAW = './GLOBE/night.jpg';
  const PATH_STARFIELD = './GLOBE/starfield.jpg';
  const PATH_COUNTRIES = './GEOJSON/countries_10m_new.geojson';
  const PATH_TRAJETS = './GEOJSON/TRAJETS_ALL_vacances_wgs.geojson';
  const PATH_EARTH_BUMP = './GLOBE/world.topo.bathy.200401.jpg';
  const loadJSON = url => fetch(url).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
  const loadImage = url => new Promise((res, rej) => { const img = new Image(); img.crossOrigin = 'anonymous'; img.onload = ()=>res(img); img.onerror = rej; img.src = url; });
  const normalizeLng = lng => ((lng + 180) % 360) - 180;
  const toggleReelBtn = document.getElementById('toggleReel');
  const cityReelEl = document.getElementById('cityReel');

// Toggle affichage bobine avec animation
toggleReelBtn.addEventListener('click', ()=>{
  cityReelEl.classList.toggle('open');
});
// Remplir la bobine avec les villes visit√©es
visitedCities.forEach(city=>{
  const div = document.createElement('div');
  div.className = 'city-card';
  div.textContent = city.name;
  div.onclick = ()=> openLeafletPopup(city); // r√©utilise ta fonction
  cityReelEl.appendChild(div);
});


      
  /* Je crois que ca sert pour les contours des pays */
  const linesFromPolygonGeom = geom => {
    const out = [];
    if(!geom) return out;
    if(geom.type === 'Polygon'){
      geom.coordinates.forEach(ring => out.push({ coords: ring.map(([x,y]) => [normalizeLng(x), y, 0.001]) }));
    } else if(geom.type === 'MultiPolygon'){
      geom.coordinates.forEach(poly => poly.forEach(ring => out.push({ coords: ring.map(([x,y]) => [normalizeLng(x), y, 0.001]) })));
    }
    return out;
  };
      
  /* Je crois que ca sert pour les trajets */
  const extractLinesFromFeature = feature => {
    const out = [], g = feature && feature.geometry;
    if(!g) return out;
    if(g.type === 'LineString'){
      out.push({ coords: g.coordinates.map(([x,y]) => [normalizeLng(x), y]) });
    } else if(g.type === 'MultiLineString'){
      g.coordinates.forEach(lineCoords => out.push({ coords: lineCoords.map(([x,y]) => [normalizeLng(x), y]) }));
    } else if(g.type === 'Polygon' || g.type === 'MultiPolygon'){
      linesFromPolygonGeom(g).forEach(l => out.push(l));
    }
    return out;
  };

  // texture nuit
  const nightTexture = (await loadImage(PATH_EARTH_NIGHT_RAW)).src;
  // chargement des donn√©es
  const [countriesGeo, trajetsGeo] = await Promise.all([
    loadJSON(PATH_COUNTRIES),
    loadJSON(PATH_TRAJETS)
  ]);
      
  // fronti√®res
  const countryLines = [];
  (countriesGeo.features || []).forEach(f => linesFromPolygonGeom(f.geometry).forEach(l => countryLines.push(l)));
      
  // trajets + collecte des valeurs uniques de `voyage`
  const trajetLines = [];
  const voyagesSet = new Set();
  const mapColor = { avion:'#00dbc5', train:'#db0016', bus:'#dbc500', voiture:'#0016db', bateau:'#0084db' };
  (trajetsGeo.features || []).forEach(f => {
    const col = mapColor[(f.properties?.trajet || f.properties?.transport || '').toLowerCase()] || '#00ffff';
    const voyageVal = (f.properties?.voyage ?? 'Inconnu');
    voyagesSet.add(voyageVal);
    extractLinesFromFeature(f).forEach(l => trajetLines.push({
      ...l,
      lineStyle:{ color: col, width: 2.5, opacity: 0.95 },
      properties:f.properties,
      voyage: voyageVal
    }));
  });
// --- G√©n√©ration de la l√©gende des trajets ---
const trajetLegendEl = document.getElementById('trajetLegend');
Object.entries(mapColor).forEach(([transport, color])=>{
  const item = document.createElement('div');
  item.style.display = 'flex';
  item.style.alignItems = 'center';
  item.style.marginBottom = '4px';
  item.innerHTML = `
    <span style="display:inline-block; width:16px; height:3px; background:${color}; margin-right:6px;"></span>
    ${transport.charAt(0).toUpperCase() + transport.slice(1)}
  `;
  trajetLegendEl.appendChild(item);
});

      
  // Style des logos des hotels
  const hotelIcon = L.divIcon({
    html: `
      <div style="
        width:33px; height:33px;
        background:#FFFFFF;;
        border:2px solid #000;
        border-radius:15%;
        display:flex; align-items:center; 
        justify-content:center;
        font-size:25px;
        box-shadow:0 3px 4px rgba(0,0,0,0.3);
      ">
        üè¢
      </div>
    `,
    className: '',
    iconSize: [28,28],
    iconAnchor: [14,14]
  });

  // Chargement de la page avec ce qui est affich√© ou non
  const globeChart = echarts.init(document.getElementById('globeContainer'), null, { renderer:'webgl' });
  let state = {
    showPays:false,
    showTrajets:false,
    showNuages:false,
    showNightShadow: false,
    showRelief:false,
    dayBase:'earth',
    activeVoyages: new Set(voyagesSet)
  };

  // Fonction qui fait plein de trucs
  function makeOption(s) {
    const series = [];
    // Fronti√®res des pays
    if(s.showPays){
      series.push({
        name: 'Pays',
        type: 'lines3D',
        coordinateSystem: 'globe',
        polyline: true,
        data: countryLines,
        lineStyle: { color: '#f0f0f0', width: 1, opacity: 0.98 }
      });
    }
    // Affiche les trajets
    if(s.showTrajets){
      const filteredTrajets = trajetLines.filter(l => s.activeVoyages.has(l.voyage));
      series.push({
        name: 'Trajets',
        type: 'lines3D',
        coordinateSystem: 'globe',
        polyline: true,
        data: filteredTrajets,
        effect: {
          show: true,
          period: 10,
          constantSpeed: 5,
          trailLength: 0.15,
          symbolSize: 6,
          color: '#FFFFFF',
        },
        lineStyle: {
          width: 2.5,
          opacity: 0.95,
        }
      });
    }
    // pins des villes visit√©es qui deviennent filtr√©es par les voyages s√©lectionn√©s
    let pinsData = [];
    const allowedCities = new Set();
    if(s.activeVoyages && s.activeVoyages.size){
      s.activeVoyages.forEach(v => {
        const list = voyagesToCities[v];
        if(Array.isArray(list)) list.forEach(city => allowedCities.add(city));
      });
    }
    if(allowedCities.size > 0){
      pinsData = visitedCities.filter(c => allowedCities.has(c.name));
    } else {
      pinsData = [];
    }
    series.push({
      name: 'Pins',
      type: 'scatter3D',
      coordinateSystem: 'globe',
      symbol: 'circle',
      symbolSize: 10,
      itemStyle: {
        color: '#FFFFFF',
        borderColor: '#000000',
        borderWidth: 0.75,
      },
      emphasis: {
        itemStyle: {
          color: '#FFD700',
          borderColor: '#000000',
          borderWidth: 1,
        },
        label: {
          show: true,
          formatter: p => p.name,
          position: 'top',
          textStyle: {
            color: '#fff',
            padding: [2, 2],
            borderRadius: 3,
            backgroundColor: 'rgba(0,0,0,1)',
            fontSize: 15,
          }
        }
      },
      data: pinsData
    });
    // Affiche le monde de nuit
    const layers = [];
    if(s.showNightShadow){
      layers.push({
        show: true,
        name: 'Ombre nuit',
        type: 'blend',
        intensity: 1.3,
        blendTo: 'emission',
        texture: PATH_EARTH_NIGHT_RAW
      });
    }
    // Affiche les nuages
    if(s.showNuages){
      layers.push({
        show: true,
        name: 'Nuages',
        type: 'overlay',
        texture: CLOUDS,
        shading: 'lambert',
        distance: 2
      });
    }
    // Change le fond du globe
    const baseDay = (s.dayBase === 'earth') ? PATH_EARTH_DAY_1 : PATH_EARTH_DAY_2;
    return {
      backgroundColor: 'transparent',
      globe: {
        baseTexture: baseDay,
        heightTexture: s.showRelief ? PATH_EARTH_BUMP : undefined,
        displacementScale: 0.025,
        shading: 'realistic',
        environment: PATH_STARFIELD,
        postEffect: { enable: false },
        light: {
          ambient: { color: '#1f1f1f', intensity: 0.2 },
          main: { color: '#FFFDED', intensity: 0.9 }
        },
        atmosphere: { show: true, color: '#a1a1a1', offset: 4 },
        viewControl: { autoRotate: false, autoRotateSpeed: 0.5 },
        layers
      },
      series
    };
  }

  // R√©cup√®re la vue du globe actuelle
  function getCurrentView() {
    const opt = globeChart.getOption();
    if(opt && opt.globe && opt.globe[0] && opt.globe[0].viewControl){
      return { ...opt.globe[0].viewControl };
    }
    return null;
  }
      
  // Permet de rafraichir l'affichage sans reset la vue
  function refresh(){
    const currentView = getCurrentView();
    const newOpt = makeOption(state);
    if(currentView) {
      newOpt.globe.viewControl = { ...newOpt.globe.viewControl, ...currentView };
    }
    globeChart.setOption(newOpt, { notMerge:true });
  }
      
  // --- UI refs ---
  const toggleNightEl = document.getElementById('toggleNight');
  const toggleReliefEl = document.getElementById('toggleRelief');
  const toggleCloudsEl = document.getElementById('toggleClouds');
  const toggleDayBaseEl = document.getElementById('toggleDayBase');
  const chkPays = document.getElementById('chkPays');
  const chkTrajets = document.getElementById('chkTrajets');
  const popupEl = document.getElementById('trajetPopup');
  const leafletPopupEl = document.getElementById('leafletPopup');
  const leafletMapEl = document.getElementById('leafletMap');
  const voyagesListEl = document.getElementById('voyagesList');

  // Remplit la liste avec les valeurs uniques de `voyage` (je ne sais pas a quoi tu sers)
  Array.from(voyagesSet).sort().forEach(v => {
    const id = 'voy_'+v.replace(/[^A-Za-z0-9_-]/g,'_');
    const label = document.createElement('label');
    label.setAttribute('for', id);
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = id;
    cb.className = 'voyageChk';
    cb.value = v;
    cb.checked = true;
    cb.setAttribute('aria-label', 'Voyage '+v);
    label.appendChild(cb);
    label.appendChild(document.createTextNode(' '+v));
    voyagesListEl.appendChild(label);
  });

  // --- √©v√©nements ---
  toggleNightEl.addEventListener('click', ()=>{
    state.showNightShadow = !state.showNightShadow;
    toggleNightEl.classList.toggle('active', state.showNightShadow);
    toggleNightEl.setAttribute('aria-pressed', String(state.showNightShadow));
    refresh();
  });
      
  toggleReliefEl.addEventListener('click', ()=>{
    state.showRelief = !state.showRelief;
    toggleReliefEl.classList.toggle('active', state.showRelief);
    toggleReliefEl.setAttribute('aria-pressed', String(state.showRelief));
    refresh();
  });
      
  toggleCloudsEl.addEventListener('click', ()=>{
    state.showNuages = !state.showNuages;
    toggleCloudsEl.classList.toggle('active', state.showNuages);
    toggleCloudsEl.setAttribute('aria-pressed', String(state.showNuages));
    refresh();
  });

  // Fonction pour changer le fond du globe
  function updateDayBaseButtonLabel(){
    toggleDayBaseEl.textContent = (state.dayBase === 'earth') ? 'EARTH' : 'TOPO';
  }
      
  toggleDayBaseEl.addEventListener('click', ()=>{
    state.dayBase = (state.dayBase === 'earth') ? 'topo' : 'earth';
    updateDayBaseButtonLabel();
    refresh();
  });

  updateDayBaseButtonLabel();

  [['Pays', chkPays], ['Trajets', chkTrajets]].forEach(([name, el])=>{
    el.addEventListener('change', e=>{
      state['show'+name] = e.target.checked;
      if(name === 'Trajets'){
        voyagesListEl.style.display = state.showTrajets ? 'block' : 'none';
        trajetLegendEl.style.display = state.showTrajets ? 'block' : 'none';
      }
      refresh();
    });
  });

  // Gestion des cases des voyages
  voyagesListEl.addEventListener('change', (e)=>{
    const t = e.target;
    if(t && t.classList.contains('voyageChk')){
      if(t.checked) state.activeVoyages.add(t.value);
      else state.activeVoyages.delete(t.value);
      refresh();
    }
  });

// === Init mainMap ===
let currentLeafletMap = L.map('mainMap').setView([11.953125, 21.371244], 3);
directionsLayer = L.layerGroup().addTo(currentLeafletMap);

function createDirectionMarkers() {
    directionsLayer.clearLayers();

    visitedCities.forEach(city => {
        city.visites.forEach(visit => {
            if (visit.rotation !== undefined && visit.coords) {
                // id unique bas√© sur la photo
                const arrowId = "arrow_" + btoa(visit.photo || city.name).replace(/=/g,"");

				let arrowIcon = L.divIcon({
				    className: "arrow-icon",
				    html: `
				        <svg id="${arrowId}" xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24"
				             style="transform: rotate(${visit.rotation}deg);">
				          <path d="M12 2 L22 12 L16 12 L16 22 L8 22 L8 12 L2 12 Z" fill="black"/>
				        </svg>
				    `,
				    iconSize: [36, 36],
				    iconAnchor: [18, 18]
				});
				
                const marker = L.marker([visit.coords[1], visit.coords[0]], { icon: arrowIcon })
                                .addTo(directionsLayer);

                // On garde un lien entre la visite et son fl√®che
                visit._arrowId = arrowId;
            }
        });
    });
}
// Gestion du switch des fl√®ches
const toggleDirections = document.getElementById("toggleDirections");
toggleDirections.addEventListener("change", function() {
    if (this.checked) {
        createDirectionMarkers();
    } else {
        directionsLayer.clearLayers();
    }
});
	
// Fonds
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Julien Houziaux | OSM'
}).addTo(currentLeafletMap);
const gmap = L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {
  attribution: 'Julien Houziaux | Google Maps'
});
const gsat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  attribution: 'Julien Houziaux | Google Satellite'
});
const osmb = new OSMBuildings().load(
  'https://{s}.data.osmbuildings.org/0.2/59fcc2e8/tile/{z}/{x}/{y}.json'
);
const baseMaps = { 
  "OpenStreetMap": osm, 
  "Google Street": gmap, 
  "Google Satellite": gsat
};
const overlayMaps = { 
  "3D buildings": osmb 
};
const layerControl = L.control.layers(baseMaps, overlayMaps).addTo(currentLeafletMap);
currentLeafletMap._layerControl = layerControl;
L.control.scale({ position: 'bottomright' }).addTo(currentLeafletMap);
L.control.sidepanel('mySidepanelLeft', {
  panelPosition: 'left',
  tabsPosition: 'left',
  startTab: 'tab-1',
  pushControls: true
}).addTo(currentLeafletMap);
	
// === Trajets ===
fetch('GEOJSON/TRAJETS_ALL_vacances_wgs.geojson')
  .then(r => r.json())
  .then(data => {
    const voyagesGroups = {};
    const layersList = currentLeafletMap._layerControl._container
      .querySelector(".leaflet-control-layers-overlays");
    // Cr√©e un conteneur suppl√©mentaire dans la l√©gende
    const voyagesContainer = document.createElement("div");
    voyagesContainer.className = "voyages-container";
    voyagesContainer.innerHTML = `<strong>Mes voyages</strong>`;
    layersList.appendChild(voyagesContainer);
    // Style des trajets
    function trajetStyle(feature) {
      const type = feature.properties.trajet || "";
      let color = "black";
      if (type === "avion") color = "#00dbc5";
      else if (type === "train") color = "#db0016";
      else if (type === "bus") color = "#dbc500";
      else if (type === "voiture") color = "#0016db";
      else if (type === "bateau") color = "#0084db";		  
      return { color, weight: 2, opacity: 1 };
    }
    function formatDateTime(str) {
      if (!str) return "";
      const d = new Date(str);
      const pad = n => n.toString().padStart(2, "0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} `
           + `${pad(d.getHours())}h${pad(d.getMinutes())}`;
    }
    // Construction des voyages
    data.features.forEach(f => {
      const voyage = f.properties.voyage || "Autres";
      if (!voyagesGroups[voyage]) voyagesGroups[voyage] = L.layerGroup();
      const trajetLayer = L.geoJSON(f, {
        style: trajetStyle,
        onEachFeature: (feature, layer) => {
          const p = feature.properties;
		  // Fonction pour formater une date en "DD/MM/YYYY HHhMM"
		  function formatDate(dateString) {
		    const date = new Date(dateString);
		    const day = String(date.getDate()).padStart(2, '0');
		    const month = String(date.getMonth() + 1).padStart(2, '0');
		    const year = date.getFullYear();
		    const hours = String(date.getHours()).padStart(2, '0');
		    const minutes = String(date.getMinutes()).padStart(2, '0');
		
		    return `${day}/${month}/${year} ${hours}h${minutes}`;
		  }
		  // Tableau de couleurs pour les voyages
		  const voyageColors = ['#FFDAB9', '#E6E6FA', '#FFB6C1', '#98FB98', '#ADD8E6', '#F0E68C'];
		  // Fonction pour obtenir une couleur en fonction du nom du voyage
		  function getVoyageColor(voyageName) {
		    let index = 0;
		    if (voyageName) {
		      index = voyageName.split('').reduce((a, b) => a + b.charCodeAt(0), 0) % voyageColors.length;
		    }
		    return voyageColors[index];
		  }
			const content = `
				<div style="font-family: Arial, sans-serif; padding: 8px; border-radius: 5px 5px 0 0; color: white; font-weight: bold; text-align: center; background-color: ${getVoyageColor(p.voyage)};">
					${p.voyage || ''}
				</div>
				<div style="font-family: Arial, sans-serif; max-width: 400px; border-radius: 5px; padding: 10px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
				  <div style="margin-bottom: 5px; font-style: italic; text-align: center;">
				    Trajet fait en ${p.trajet || ''}
				  </div>
				  <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
				    <thead>
				      <tr>
				        <th colspan="2" style="border: 1px solid #ccc; padding: 8px; text-align: center; background-color: #f9f9f9;">D√©part</th>
				        <th colspan="2" style="border: 1px solid #ccc; padding: 8px; text-align: center; background-color: #f9f9f9;">Arriv√©e</th>
				      </tr>
				    </thead>
				    <tbody>
				      <tr>
				        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">
				          ${formatDate(p.date_deb).split(' ')[0]}
				        </td>
				        <td colspan="2" rowspan="2" style="border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: middle; background-color: #f9f9f9;">
				          ${p.duree || ''}
				        </td>
				        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">
				          ${formatDate(p.date_fin).split(' ')[0]}
				        </td>
				      </tr>
				      <tr>
				        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">
				          ${formatDate(p.date_deb).split(' ')[1]}
				        </td>
				        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">
				          ${formatDate(p.date_fin).split(' ')[1]}
				        </td>
				      </tr>
				      <tr>
				        <td colspan="4" style="border: 1px solid #ccc; padding: 8px; text-align: center;">
				          ${p.distanceKM || ''} km
				        </td>
				      </tr>
				    </tbody>
				  </table>
				</div>
			`;
          layer.bindPopup(content);
        }
      });
      voyagesGroups[voyage].addLayer(trajetLayer);
    });
    // Ajoute chaque voyage comme case √† cocher
    Object.keys(voyagesGroups).sort().forEach(v => {
      const id = "voy_" + v.replace(/[^A-Za-z0-9_-]/g, "_");
      const label = document.createElement("label");
      label.style.display = "block";
      label.style.cursor = "pointer";
      label.innerHTML = `<input type="checkbox" id="${id}" checked> ${v}`;
      voyagesContainer.appendChild(label);
      const cb = label.querySelector("input");
      cb.addEventListener("change", () => {
        if (cb.checked) {
          voyagesGroups[v].addTo(currentLeafletMap);
        } else {
          currentLeafletMap.removeLayer(voyagesGroups[v]);
        }
      });
      // ajoute par d√©faut
      voyagesGroups[v].addTo(currentLeafletMap);
    });
  });

const redIcon = new L.Icon({
  iconUrl: './GLOBE/symboles/marker-icon-red.png',
  iconRetinaUrl: './GLOBE/symboles/marker-icon-2x-red.png',
  shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});



// Cr√©e l‚Äôoverlay plein √©cran si absent, et expose window.openPhotoPopup(...)
(function ensurePhotoOverlay(){
  if (document.getElementById('photoOverlay')) return;
  const overlay = document.createElement('div');
  overlay.id = 'photoOverlay';
  overlay.className = 'photo-overlay';
  overlay.innerHTML = `
    <button class="overlay-close" aria-label="Fermer">&times;</button>
    <img id="photoOverlayImg" alt="">
  `;
  document.body.appendChild(overlay);

  const img = overlay.querySelector('#photoOverlayImg');
  const close = () => overlay.classList.remove('open');

  overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
  overlay.querySelector('.overlay-close').addEventListener('click', close);
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

  // Fonction globale appel√©e par le bouton "agrandir"
  window.openPhotoPopup = (url) => {
    img.src = url;
    overlay.classList.add('open');
  };
})();

function openLeafletPopup(cityData) {
  if (!currentLeafletMap) return;

  // Supprimer anciens markers
  if (currentLeafletMap._photoMarkers) {
    currentLeafletMap._photoMarkers.forEach(m => currentLeafletMap.removeLayer(m));
  }
  currentLeafletMap._photoMarkers = [];

  // Recentrer la carte
  const [lon, lat] = cityData.value;
  const config = cityViewConfig[cityData.name] || { center: [lat, lon], zoom: 13 };
  currentLeafletMap.setView(config.center, config.zoom);

  // --- Markers / popups ---
  (cityData.visites || []).forEach(v => {
    const [vlon, vlat] = v.coords;

    // H√¥tel
    if (v.type === "hotel") {
      const marker = L.marker([vlat, vlon], { icon: hotelIcon })
        .addTo(currentLeafletMap)
        .bindPopup(`<b>Hotel</b><br>Du ${v.datedeb} au ${v.datefin}`);
      currentLeafletMap._photoMarkers.push(marker);
      return;
    }

    // Photo
    if (v.photo) {
      let year, month, day, dateInfo = "";
      const photoName = v.photo.split('/').pop();
      const dateMatch = photoName.match(/IMG[-_]?(\d{4})(\d{2})(\d{2})[-_]?([A-Za-z]{2})?(\d{6})?/);
      if (dateMatch) {
        year = dateMatch[1];
        month = dateMatch[2];
        day = dateMatch[3];
        const time = dateMatch[5];
        dateInfo = `Le ${day}/${month}/${year}`;
        if (time) {
          const h = time.substring(0, 2);
          const m = time.substring(2, 4);
          const s = time.substring(4, 6);
          dateInfo += ` √† ${h}h${m}m${s}s`;
        }
      }
      const popupContent = document.createElement("div");
      popupContent.innerHTML = `
        <b>${v.name || ""}</b><br>
        <div style="position: relative; display: inline-block;">
          <img src="${v.photo}" width="250" style="display:block;border-radius:4px;"/>
          <button class="enlarge-btn" data-photo="${v.photo}">‚§¢</button>
        </div>
		<small style="display: block; margin-top: 4px; color: #666;">${dateInfo}</small>
      `;

      const showDir = document.getElementById("toggleDirections").checked;

      const marker = L.marker([vlat, vlon], {
        icon: new L.Icon.Default()
      }).bindPopup(popupContent).addTo(currentLeafletMap);

      v._marker = marker;
      currentLeafletMap._photoMarkers.push(marker);

      // Bouton agrandir
      marker.on("popupopen", (e) => {
        const container = e.popup.getElement();
        if (!container) return;
        const btns = container.querySelectorAll(".enlarge-btn");
        btns.forEach((btn) => {
          L.DomEvent.disableClickPropagation(btn);
          btn.addEventListener("click", (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            const url = btn.getAttribute("data-photo");
            if (window.openPhotoPopup) window.openPhotoPopup(url);
          });
        });
      });
    }
  });

  // --- Mettre √† jour l‚Äôonglet 3 (photos) ---
  const photosTab = document.querySelector('[data-tab-content="tab-3"]');
  photosTab.innerHTML = `<h4 style="font-size:1.2em; margin-bottom:10px;" data-lang-text="FR:Les photos;EN:The photos;CH:ÁÖßÁâá"></h4>`;

  // Trier photos par date
  const photosList = (cityData.visites || [])
    .filter(v => v.photo)
    .map(v => {
      const photoName = v.photo.split('/').pop();
      const dateMatch = photoName.match(/IMG[-_]?(\d{4})(\d{2})(\d{2})(?:[-_]?([A-Za-z]{2}))?(\d{6})?/);
      let dateKey = "99999999";
      let timeText = "";
      if (dateMatch) {
        dateKey = dateMatch[1] + dateMatch[2] + dateMatch[3];
        if (dateMatch[5]) {
          const h = dateMatch[5].substring(0, 2);
          const m = dateMatch[5].substring(2, 4);
          const s = dateMatch[5].substring(4, 6);
          timeText = `${h}h${m}m${s}s`;
        }
      }
      return { ...v, photoName, dateKey, timeText };
    })
    .sort((a, b) => a.dateKey.localeCompare(b.dateKey) || a.timeText.localeCompare(b.timeText));

  // Regrouper par jour
  const groupedByDay = {};
  photosList.forEach(v => {
    if (!groupedByDay[v.dateKey]) groupedByDay[v.dateKey] = [];
    groupedByDay[v.dateKey].push(v);
  });

  if (photosList.length === 0) {
    photosTab.innerHTML += "<p>Aucune photo pour cette ville.</p>";
  } else {
    const container = document.createElement("div");
    container.className = "photos-list";

    Object.keys(groupedByDay).sort().forEach(dateKey => {
      const year = dateKey.slice(0, 4);
      const month = dateKey.slice(4, 6);
      const day = dateKey.slice(6, 8);
      const dateObj = new Date(`${year}-${month}-${day}`);
      const dateFormatted = dateObj.toLocaleDateString("fr-FR", {
        day: "numeric",
        month: "long",
        year: "numeric"
      });

      const dayTitle = document.createElement("div");
      dayTitle.innerHTML = `<strong style="display:block; margin-top:20px; font-size:15px;">${dateFormatted}</strong>
                            <hr style="margin:4px 0 10px; border:none; border-top:1px solid #ccc;">`;
      container.appendChild(dayTitle);

      groupedByDay[dateKey].forEach(v => {
        const item = document.createElement("div");
        item.className = "photo-item";
        item.style.marginBottom = "14px";
        const displayName = v.name || v.photoName;

        item.innerHTML = `
          <div style="cursor:pointer; text-align:center;">
            <img src="${v.photo}" style="width:90%; border-radius:6px; display:block; margin:0 auto;"/>
            <div style="margin-top:4px; font-weight:600;">
              ${displayName} 
              ${v.timeText ? `<span style="font-size:12px; color:#666;"> (${v.timeText})</span>` : ""}
            </div>
          </div>
        `;

        // Clic = zoomer sur marker
        item.addEventListener("click", () => {
          if (v._marker) {
            currentLeafletMap.setView(v._marker.getLatLng(), 16);
            v._marker.openPopup();
          }
        });

		// Survol = marker rouge + fl√®che rouge
		item.addEventListener("mouseenter", () => {
		  if (v._marker) v._marker.setIcon(redIcon);
		  if (v._arrowId) {
		    const arrow = document.getElementById(v._arrowId);
		    if (arrow) arrow.querySelector("path").setAttribute("fill", "red");
		  }
		});
		item.addEventListener("mouseleave", () => {
		  if (v._marker) v._marker.setIcon(new L.Icon.Default());
		  if (v._arrowId) {
		    const arrow = document.getElementById(v._arrowId);
		    if (arrow) arrow.querySelector("path").setAttribute("fill", "black");
		  }
		});
        container.appendChild(item);
      });
    });
    photosTab.appendChild(container);
  }
  currentLeafletMap.invalidateSize();
}

      
// Fonction pour ouvrir la popup de photo agrandie
function openPhotoPopup(photoUrl) {
  const photoPopup = document.getElementById('photoPopup');
  const photoPopupImg = document.getElementById('photoPopupImg');
  photoPopupImg.src = photoUrl;
  photoPopup.style.display = 'flex';
}


// Fonction pour fermer la popup de photo agrandie
function closePhotoPopup() {
  document.getElementById('photoPopup').style.display = 'none';
  // r√©-afficher les contr√¥les Leaflet
  document.querySelectorAll('.leaflet-control-container').forEach(el => {
    el.style.display = '';
  });
}

// √âcouteurs d'√©v√©nements pour la popup de photo
document.getElementById('photoClose').addEventListener('click', closePhotoPopup);
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closePhotoPopup();
  }
});
document.getElementById('photoPopup').addEventListener('click', (e) => {
  if (e.target === document.getElementById('photoPopup')) {
    closePhotoPopup();
  }
});


  // CETTE FONCTION NE MARCHE PAS
  // clic sur globe
	function formatDateTime(str) {
	  if (!str) return "";
	  const d = new Date(str);
	  const pad = n => n.toString().padStart(2, "0");
	  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} `
	       + `${pad(d.getHours())}h${pad(d.getMinutes())}`;
	}
	  globeChart.on('click', params => {
	    if(params.seriesName === 'Trajets' && params.data && params.data.properties){
	      const p = params.data.properties;
	      const popupEl = document.getElementById('trajetPopup');
	popupEl.innerHTML = `
	  <strong>Trajet:</strong> ${p.trajet || ''}<br/>
	  <strong>Voyage:</strong> ${p.voyage || ''}<br/>
	  <strong>Date d√©but:</strong> ${formatDateTime(p.date_deb)}<br/>
	  <strong>Date fin:</strong> ${formatDateTime(p.date_fin)}<br/>
	  <strong>Dur√©e:</strong> ${p.duree || ''}<br/>
	  <strong>Distance:</strong> ${p.distanceKM || ''} km
	`;
      popupEl.style.display = 'block';
    } else if(params.seriesName === 'Pins' && params.data){
      const popupEl = document.getElementById('trajetPopup');
      popupEl.style.display = 'none';
      openLeafletPopup(params.data);
    } else {
      const popupEl = document.getElementById('trajetPopup');
      popupEl.style.display = 'none';
    }
  });

  // rendu initial
  voyagesListEl.style.display = state.showTrajets ? 'block' : 'none';
  refresh();


document.querySelectorAll('.city-btn').forEach(btn => {
  const cityName = btn.querySelector('span').textContent.trim();
  const cityData = visitedCities.find(c => c.name === cityName);
  if (!cityData) return;

  btn.addEventListener('click', () => {
    openLeafletPopup(cityData); // ‚Üí met √† jour mainMap et tab3
  });
});
	
// Gestion du globe popup
const globePopup = document.getElementById('globePopup');
const toggleGlobeBtn = document.getElementById('toggleGlobeBtn');
const globeClose = document.getElementById('globeClose');
toggleGlobeBtn.addEventListener('click', () => {
  if (globePopup.style.display === 'block') {
    globePopup.style.display = 'none';
  } else {
    globePopup.style.display = 'block';
    globeChart.resize(); // tr√®s important : recalculer echarts
  }
});
globeClose.addEventListener('click', () => {
  globePopup.style.display = 'none';
});
})();	
</script>
</body>
</html>
