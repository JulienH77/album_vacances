<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" href="https://static.vecteezy.com/ti/vecteur-libre/p1/22395051-voyage-agence-vecteur-logo-modele-vacances-logo-modele-globe-en-voyageant-logo-vecteur-conception-vectoriel.jpg">
<title>Mes vacances</title>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<style>
  html,body,#root { height:100%; margin:0; padding:0; }
  body{
    /*background: url('./GLOBE/starfield.jpg') no-repeat center center fixed;*/
    background-color: black;
    background-size: cover;
    font-family: Inter, Arial, sans-serif;
  }
  #root { position:relative; width:100%; height:100%; overflow:hidden; }
  #globeContainer { width:100%; height:100%; }

  /* Toggle jour/nuit */
  #toggle {
    position:absolute; top:14px; left:14px;
    width:100px; height:40px; border-radius:22px;
    display:flex; align-items:center; justify-content:space-between;
    padding:4px 8px; cursor:pointer; z-index:120; user-select:none;
    background: linear-gradient(90deg,#ffe066 50%, #4a90e2 50%);
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }
  #toggle.night { background: linear-gradient(90deg,#4a90e2 50%, #ffe066 50%); }
  #toggle .ball {
    position:absolute; top:4px; left:4px;
    width:32px; height:32px; border-radius:50%;
    background:#ffd54a;
    box-shadow:0 6px 16px rgba(255,213,74,0.28);
    transition:left .28s, background .28s;
  }
  #toggle.night .ball { left:64px; background:#f1d56d; }

  /* Toggle relief (rond) */
  #toggleRelief {
    position: absolute;
    top: 80px;
    left: 18px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 120;
    user-select: none;
    background: rgba(255,255,255,0.9);
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    transition: background 0.2s, transform 0.15s;
  }
  #toggleRelief.active { background: rgba(180,255,180,0.9); }
  #toggleRelief:active { transform: scale(0.95); }

  /* Toggle nuages (rond) */
  #toggleClouds {
    position: absolute;
    top: 134px;
    left: 18px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 120;
    user-select: none;
    background: rgba(255,255,255,0.9);
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    transition: background 0.2s, transform 0.15s;
  }
  #toggleClouds.active { background: rgba(180,220,255,0.9); }
  #toggleClouds:active { transform: scale(0.95); }

  /* Bouton carr√© fond du jour (en bas √† gauche) */
  #toggleDayBase {
    position: absolute;
    left: 18px;
    bottom: 18px;
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 120;
    user-select: none;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    font-weight: 700;
    font-size: 12px;
    text-align: center;
    line-height: 1.1;
  }
  #toggleDayBase:active { transform: scale(0.97); }

  /* L√©gende */
  #legend {
    position:absolute; top:14px; right:14px; z-index:120;
    background: rgba(255,255,255,0.92);
    padding:10px 12px; border-radius:10px;
    min-width:160px; box-shadow:0 6px 18px rgba(0,0,0,0.18);
  }
  #legend label { display:flex; align-items:center; gap:10px; font-weight:600; }
  #legend input[type=checkbox] { width:16px; height:16px; }

  /* Lune */
  #moonPreview {
    position:absolute; bottom:14px; right:14px;
    width:140px; height:140px; z-index:110; border-radius:50%;
    overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.6); background:black;
  }

  /* Popup stats */
  #trajetPopup {
    position:absolute; bottom:20px; left:20px;
    background:rgba(0,0,0,0.85); color:white;
    padding:10px 14px; border-radius:8px;
    font-size:14px; line-height:1.4; max-width:300px;
    display:none; z-index:200;
  }

  /* Popup Leaflet plein √©cran */
  #leafletPopup {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    z-index: 400;
  }
  #leafletMap {
    width: 90%; height: 90%;
    margin: 40px auto;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  }
  #leafletClose {
    position: absolute; top: 20px; right: 20px;
    background: #fff; border: none;
    border-radius: 50%; width: 36px; height: 36px;
    cursor: pointer; font-size: 18px; font-weight: bold;
  }

  /* --- AJOUT: styles de la liste d√©pliable des voyages --- */
  #voyagesDetails { margin-top:8px; }
  #voyagesDetails[hidden] { display:none; }
  #voyagesDetails summary { cursor:pointer; font-weight:700; }
  #voyagesList { margin-top:6px; max-height:260px; overflow:auto; padding-left:2px; }
  #voyagesList label { display:flex; align-items:center; gap:8px; font-weight:500; }
</style>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<div id="root">
  <div id="globeContainer" class="echarts-for-globe"></div>

  <!-- Boutons -->
  <div id="toggle" role="button" aria-pressed="false" aria-label="Basculer jour/nuit">
    <svg class="sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" fill="#FFD43B"/></svg>
    <svg class="moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z" fill="#FFDD66"/></svg>
    <div class="ball" aria-hidden="true"></div>
  </div>
  <div id="toggleRelief" role="button" aria-pressed="false" aria-label="Basculer relief">
    <svg viewBox="0 0 24 30">
      <path d="M3 20l5-9 4 7 5-10 5 12z" fill="#444"/>
      <path d="M3 20h18v1H3z" fill="#777"/>
    </svg>
  </div>
  <div id="toggleClouds" role="button" aria-pressed="false" aria-label="Afficher/masquer les nuages" class="">
    <svg viewBox="0 0 24 24" width="22" height="22">
      <path d="M6 19h11a4 4 0 0 0 0-8 5 5 0 0 0-9.8-1.7A4 4 0 0 0 6 19z" fill="#4a90e2"/>
    </svg>
  </div>
  <div id="toggleDayBase" role="button" aria-label="Changer fond du jour" title="Changer fond du jour">EARTH</div>

  <!-- L√©gende -->
  <div id="legend" role="group" aria-label="Contr√¥les des couches">
    <label><input id="chkPays" type="checkbox"> Limites (Pays)</label>
    <label><input id="chkTrajets" type="checkbox"> Trajets</label>

    <!-- AJOUT : liste des voyages directement sous "Trajets" -->
    <div id="voyagesList" role="group" aria-label="Liste des voyages" style="display:none; margin-top:6px; max-height:260px; overflow:auto;"></div>
  </div>

  <!-- Lune -->
  <div id="trajetPopup"></div>
</div>

<!-- Popup Leaflet -->
<div id="leafletPopup">
  <div id="leafletMap"></div>
  <button id="leafletClose">X</button>
</div>

<script>
(async function(){
  const PATH_EARTH_DAY_1 = './GLOBE/earth.jpg';
  /*const PATH_EARTH_DAY_1 = './GLOBE/earth_high_quality.png';*/
  const PATH_EARTH_DAY_2 = './GLOBE/world.topo.bathy.200401.jpg';
  const CLOUDS = 'https://clouds.matteason.co.uk/images/4096x2048/clouds-alpha.png';
  const PATH_EARTH_NIGHT_RAW = './GLOBE/night.jpg';
  /*const PATH_EARTH_NIGHT_RAW = './GLOBE/night_high_quality.png';*/
  const PATH_STARFIELD = './GLOBE/starfield.jpg';
  const PATH_COUNTRIES = './GEOJSON/countries_10m_new.geojson';
  const PATH_TRAJETS = './GEOJSON/TRAJETS_ALL_vacances_wgs.geojson';
  const PATH_EARTH_BUMP = './GLOBE/world.topo.bathy.200401.jpg';

  const loadJSON = url => fetch(url).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
  const loadImage = url => new Promise((res, rej) => { const img = new Image(); img.crossOrigin = 'anonymous'; img.onload = ()=>res(img); img.onerror = rej; img.src = url; });
  const normalizeLng = lng => ((lng + 180) % 360) - 180;





  
  const linesFromPolygonGeom = geom => {
    const out = [];
    if(!geom) return out;
    if(geom.type === 'Polygon'){
      geom.coordinates.forEach(ring => out.push({ coords: ring.map(([x,y]) => [normalizeLng(x), y, 0.001]) }));
    } else if(geom.type === 'MultiPolygon'){
      geom.coordinates.forEach(poly => poly.forEach(ring => out.push({ coords: ring.map(([x,y]) => [normalizeLng(x), y, 0.001]) })));
    }
    return out;
  };

  const extractLinesFromFeature = feature => {
    const out = [], g = feature && feature.geometry;
    if(!g) return out;
    if(g.type === 'LineString'){
      out.push({ coords: g.coordinates.map(([x,y]) => [normalizeLng(x), y]) });
    } else if(g.type === 'MultiLineString'){
      g.coordinates.forEach(lineCoords => out.push({ coords: lineCoords.map(([x,y]) => [normalizeLng(x), y]) }));
    } else if(g.type === 'Polygon' || g.type === 'MultiPolygon'){
      linesFromPolygonGeom(g).forEach(l => out.push(l));
    }
    return out;
  };

  // texture nuit
  const nightTexture = (await loadImage(PATH_EARTH_NIGHT_RAW)).src;

  // chargement des donn√©es
  const [countriesGeo, trajetsGeo] = await Promise.all([
    loadJSON(PATH_COUNTRIES),
    loadJSON(PATH_TRAJETS)
  ]);

  // fronti√®res
  const countryLines = [];
  (countriesGeo.features || []).forEach(f => linesFromPolygonGeom(f.geometry).forEach(l => countryLines.push(l)));

  // trajets + collecte des valeurs uniques de `voyage`
  const trajetLines = [];
  const voyagesSet = new Set();
  const mapColor = { avion:'#00dbc5', train:'#db0016', bus:'#dbc500', voiture:'#0016db', bateau:'#0084db' };
  (trajetsGeo.features || []).forEach(f => {
    const col = mapColor[(f.properties?.trajet || f.properties?.transport || '').toLowerCase()] || '#00ffff';
    const voyageVal = (f.properties?.voyage ?? 'Inconnu');
    voyagesSet.add(voyageVal);
    extractLinesFromFeature(f).forEach(l => trajetLines.push({
      ...l,
      lineStyle:{ color: col, width: 2.5, opacity: 0.95 },
      properties:f.properties,
      voyage: voyageVal
    }));
  });

  // Mapping voyage -> villes demand√©es par l'utilisateur
  const voyagesToCities = {
    'May 2025 - China': ['Beijing','Xi\'an','Shanghai','Hangzhou','Guilin','Yangshuo','Tianjin'],
    'July 2025 - Central Europe': ['Munich','Marquartstein','Salzburg','Budapest','Prague','Regensburg','Ulm']
  };

  // villes visit√©es avec visites/photos (inchang√©)
  const visitedCities = [
    {
      name: 'Beijing',
      value: [116.383331, 39.916668, 0],
      visites: [
        { name:'Cit√© interdite', coords:[116.39082, 39.91691], photo:'citeinterdire.jpg' },
        { name:'Palais d √©t√©', coords:[116.26793, 39.99761], photo:'palaisdete.jpg' }
      ]
    },
    {
      name: 'Xi\'an',
      value: [108.94243, 34.264533, 0],
      visites: [
        { name:'Cit√© interdite', coords:[116.39082, 39.91691], photo:'citeinterdire.jpg' },
        { name:'Palais d √©t√©', coords:[116.26793, 39.99761], photo:'palaisdete.jpg' }
      ]
    },
    {
      name: 'Shanghai',
      value: [121.4737, 31.2304, 0],
      visites: [
        { name:'Bund', coords:[121.490317, 31.241666], photo:'bund.jpg' },
        { name:'Yu Garden', coords:[121.4926, 31.2272], photo:'yugarden.jpg' }
      ]
    },
    {
      name: 'Hangzhou',
      value: [120.17478, 30.27338, 0],
      visites: [
        { name:'Cit√© interdite', coords:[116.39082, 39.91691], photo:'citeinterdire.jpg' },
        { name:'Palais d √©t√©', coords:[116.26793, 39.99761], photo:'palaisdete.jpg' }
      ]
    },
    {
      name: 'Guilin',
      value: [110.28782, 25.27805, 0],
      visites: [
        { name:'Cit√© interdite', coords:[116.39082, 39.91691], photo:'citeinterdire.jpg' },
        { name:'Palais d √©t√©', coords:[116.26793, 39.99761], photo:'palaisdete.jpg' }
      ]
    },
    {
      name: 'Yangshuo',
      value: [110.486715, 24.7791743, 0],
      visites: [
        { name:'Cit√© interdite', coords:[116.39082, 39.91691], photo:'citeinterdire.jpg' },
        { name:'Palais d √©t√©', coords:[116.26793, 39.99761], photo:'palaisdete.jpg' }
      ]
    },
    {
      name: 'Tianjin',
      value: [117.18850, 39.13867, 0],
      visites: [
        { name:'Cit√© interdite', coords:[116.39082, 39.91691], photo:'citeinterdire.jpg' },
        { name:'Palais d √©t√©', coords:[116.26793, 39.99761], photo:'palaisdete.jpg' }
      ]
    },
    {
      name: 'Munich',
      value: [11.57251, 48.13922, 0],
      visites: [
        { type: 'hotel', coords:[11.622536, 48.136962] },
        { name:'Marienplatz', coords:[11.57566, 48.13707], photo:'./IMG/2025/Central Europe/Munich/IMG_20250712_145518.jpg' },
        { name:'Cathedral', coords:[11.57251, 48.13863], photo:'./IMG/2025/Central Europe/Munich/IMG_20250712_173138.jpg' },
        { name:'Beer at the englischergarten', coords:[11.59248, 48.15229], photo:'./IMG/2025/Central Europe/Munich/IMG_20250712_193124.jpg' },
        { name:'Leaving the garten', coords:[11.596034, 48.1503655], photo:'./IMG/2025/Central Europe/Munich/IMG_20250712_203324.jpg' },
        { name:'Waiting for her laundry', coords:[11.60667, 48.12429], photo:'./IMG/2025/Central Europe/Munich/IMG_20250712_221519.jpg' },
        { name:'Last meal before the end', coords:[11.56099, 48.13865], photo:'./IMG/2025/Central Europe/Munich/IMG_20250727_140041.jpg' }
      ]
    },
    {
      name: 'Marquartstein',
      value: [12.46238, 47.75929, 0],
      visites: [
        { name:'On a walk', coords:[12.46436, 47.757624], photo:'./IMG/2025/Central Europe/Marquartstein/IMG_20250713_135813.jpg' },
        { name:'Cute girl and a bin', coords:[12.465336, 47.75557], photo:'./IMG/2025/Central Europe/Marquartstein/IMG_20250713_140715.jpg' },
        { name:'The lion girl', coords:[12.46704, 47.75209], photo:'./IMG/2025/Central Europe/Marquartstein/IMG_20250713_141521.jpg' },
        { name:'Barbie was lost', coords:[12.46681, 47.751229], photo:'./IMG/2025/Central Europe/Marquartstein/IMG_20250713_141835.jpg' },
        { name:'Fuck the rain', coords:[12.463480, 47.759179], photo:'./IMG/2025/Central Europe/Marquartstein/IMG_20250713_150552.jpg' }
      ]
    },
    {
      name: 'Salzburg',
      value: [13.04159, 47.80523, 0],
      visites: [
        { type: 'hotel', coords:[13.037606, 47.810420] },
        { name:'Mozart Diner Concert', coords:[13.0441398, 47.7970268], photo:'./IMG/2025/Central Europe/Salzburg/IMG_20250713_185800.jpg' },
        { name:'Mozart Birth Place', coords:[13.043580, 47.79991], photo:'./IMG/2025/Central Europe/Salzburg/IMG_20250714_131540.jpg' },
        { name:'Roof of the Castle', coords:[13.046522, 47.794979], photo:'./IMG/2025/Central Europe/Salzburg/IMG_20250714_165226.jpg' },
        { name:'First ap√©ro evening', coords:[13.052116, 47.796713], photo:'./IMG/2025/Central Europe/Salzburg/IMG_20250714_214406.jpg' },
        { name:'Beautiful night sky view', coords:[13.037349, 47.804998], photo:'./IMG/2025/Central Europe/Salzburg/IMG_20250714_012446.jpg' },
        { name:'My street', coords:[13.03803, 47.810573], photo:'./IMG/2025/Central Europe/Salzburg/IMG-20250715-WA0036.jpg' }
      ]
    },
    {
      name: 'Budapest',
      value: [19.05196, 47.49394, 0],
      visites: [
        { type: 'hotel', coords:[19.0628424, 47.4977553] },
        { name:'Heroes square', coords:[19.077351, 47.514584], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250718_191011.jpg' },
        { name:'The cutest', coords:[19.080105, 47.516005], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250718_193447.jpg' },
        { name:'Us and the old castle of Pest', coords:[19.0816144, 47.5159559], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250718_194127.jpg' },
        { name:'Ruin bar', coords:[19.06287432, 47.49678406], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250719_003008.jpg' },
        { name:'Snow White and the bird', coords:[19.06256, 47.497044], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250719_121752.jpg' },
        { name:'Going to the Museum in the castle of Buda', coords:[19.041502, 47.495178], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250719_133222.jpg' },
        { name:'Resting time in the museum', coords:[19.039736, 47.495084], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250719_154009.jpg' },
        { name:'Photo of us', coords:[19.041387, 47.495095], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250719_171040.jpg' },
        { name:'Fishermen\'s church', coords:[19.033740, 47.501323], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250719_183722.jpg' },
        { name:'My beauty and the parliament', coords:[19.03952892, 47.506152106], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250719_200219.jpg' },
        { name:'Parliament of Budapest', coords:[19.04688, 47.50800], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250720_192616.jpg' },
        { name:'On the way to the thermal baths', coords:[19.06856, 47.50860], photo:'./IMG/2025/Central Europe/Budapest/IMG_20250721_111258_1.jpg' },
        { name:'Entr√©e au Ruin bar', coords:[19.06335, 47.497006], photo:'./IMG/2025/Central Europe/Budapest/IMG-20250718-WA0004.jpg' },
        { name:'In the Ruin bar', coords:[19.06299, 47.49687], photo:'./IMG/2025/Central Europe/Budapest/IMG-20250728-WA0175.jpg' },
        { name:'Us and the castel of Pest', coords:[19.08303, 47.51652], photo:'./IMG/2025/Central Europe/Budapest/IMG-20250728-WA0193.jpg' },
        { name:'Luggage locker', coords:[19.08311, 47.50028], photo:'./IMG/2025/Central Europe/Budapest/IMG-20250728-WA0217.jpg' },
      ]
    },
    {
      name: 'Prague',
      value: [14.42037, 50.08427, 0],
      visites: [
        { type: 'hotel', coords:[14.454204, 50.094476] },
        { name:'Powder tower', coords:[14.42802, 50.08691], photo:'./IMG/2025/Central Europe/Prague/IMG_20250722_140357.jpg' },
        { name:'Astronomical clock', coords:[14.42067, 50.08700], photo:'./IMG/2025/Central Europe/Prague/IMG_20250722_144513.jpg' },
        { name:'Astronomical clock\'s square', coords:[14.42125, 50.08711], photo:'./IMG/2025/Central Europe/Prague/IMG_20250722_144953.jpg' },
        { name:'Forced to eat', coords:[14.41971, 50.08665], photo:'./IMG/2025/Central Europe/Prague/IMG_20250722_154732.jpg' },
        { name:'Old tavern', coords:[14.40156, 50.08898], photo:'./IMG/2025/Central Europe/Prague/IMG_20250722_204124.jpg' },
        { name:'Church of the infant Jesus', coords:[14.40365, 50.08572], photo:'./IMG/2025/Central Europe/Prague/IMG_20250723_165037.jpg' },
        { name:'The Lennon wall', coords:[14.406930, 50.086249], photo:'./IMG/2025/Central Europe/Prague/IMG_20250723_180908.jpg' },
        { name:'London underground bar', coords:[14.41934, 50.08147], photo:'./IMG/2025/Central Europe/Prague/IMG_20250723_205251.jpg' },
        { name:'Distorting mirror', coords:[14.42559, 50.08526], photo:'./IMG/2025/Central Europe/Prague/IMG-20250727-WA0011.jpg' },
        { name:'Frog guy with a frog on the Lennon wall', coords:[14.406810, 50.086249], photo:'./IMG/2025/Central Europe/Prague/IMG-20250728-WA0298.jpg' },
        { name:'Delicious meal in a pub', coords:[14.40824, 50.08629], photo:'./IMG/2025/Central Europe/Prague/IMG-20250728-WA0306.jpg' }
      ]
    },
    {
      name: 'Regensburg',
      value: [12.09421, 49.02009, 0],
      visites: [
        { type: 'hotel', coords:[12.107303, 49.014029] },
        { name:'An old tower', coords:[12.10843, 49.01792], photo:'./IMG/2025/Central Europe/Regensburg/IMG_20250725_121358.jpg' },
        { name:'Caf√© Lorraine', coords:[12.10154, 49.01750], photo:'./IMG/2025/Central Europe/Regensburg/IMG_20250725_125458.jpg' },
        { name:'Us on the old bridge', coords:[12.09711, 49.02176], photo:'./IMG/2025/Central Europe/Regensburg/IMG_20250725_151955.jpg' },
        { name:'View of Regensburg', coords:[12.10189, 49.02126], photo:'./IMG/2025/Central Europe/Regensburg/IMG_20250725_165907.jpg' }
      ]
    },
    {
      name: 'Ulm',
      value: [9.99271, 48.39848, 0],
      visites: [
        { type: 'hotel', coords:[9.983286, 48.39558] },
        { name:'No room...', coords:[9.983286, 48.39558], photo:'./IMG/2025/Central Europe/Ulm/IMG_20250726_031056.jpg' },
        { name:'The tallest cathedral in the world', coords:[9.990807, 48.39833], photo:'./IMG/2025/Central Europe/Ulm/IMG_20250726_143246.jpg' },
        { name:'The townhall', coords:[9.993648, 48.39700], photo:'./IMG/2025/Central Europe/Ulm/IMG_20250726_160509.jpg' },
        { name:'The most leaning hotel in the world', coords:[9.991303, 48.39557], photo:'./IMG/2025/Central Europe/Ulm/IMG_20250726_162846.jpg' },
        { name:'Cute bridge, river and us', coords:[9.9909279, 48.395416], photo:'./IMG/2025/Central Europe/Ulm/IMG_20250726_163153.jpg' },
        { name:'Einstein fountain', coords:[10.001146, 48.400465], photo:'./IMG/2025/Central Europe/Ulm/IMG_20250726_180211.jpg' }
      ]
    } 
  ];




const hotelIcon = L.divIcon({
  html: `
    <div style="
      width:28px; height:28px;
      background:#128019;
      border:2px solid #000;
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:16px; font-weight:bold; color:white;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    ">
      üè¢
    </div>
  `,
  className: '', // important: √©viter la classe par d√©faut Leaflet
  iconSize: [28,28],
  iconAnchor: [14,14]
});

  
  const globeChart = echarts.init(document.getElementById('globeContainer'), null, { renderer:'webgl' });
  let state = {
    showPays:false,
    showTrajets:false,
    showNuages:false,
    isNight:false,
    showRelief:false,
    dayBase:'earth',
    activeVoyages: new Set(voyagesSet) // AJOUT : filtre actif
  };

  function makeOption(s) {
  const series = [];
// Fronti√®res des pays
if(s.showPays){
  series.push({
    name: 'Pays',
    type: 'lines3D',
    coordinateSystem: 'globe',
    polyline: true,
    data: countryLines,
    lineStyle: { color: '#f0f0f0', width: 1, opacity: 0.98 }
  });
}
  if(s.showTrajets){
    const filteredTrajets = trajetLines.filter(l => s.activeVoyages.has(l.voyage));
series.push({
  name: 'Trajets',
  type: 'lines3D',
  coordinateSystem: 'globe',
  polyline: true,
  data: filteredTrajets,
  effect: {
    show: true,
    period: 10, // Temps pour un cycle complet (en secondes)
    constantSpeed: 5, // Vitesse constante (pixels/seconde)
    trailLength: 0.15,
    /*symbol: 'path://M0,0 L10,5 L0,10 Z',*/ // Triangle blanc
    symbolSize: 6,
    color: '#FFFFFF',
  },
  lineStyle: {
    width: 2.5,
    opacity: 0.95,
  }
});
  }
    
  // pins des villes visit√©es ‚Äî maintenant filtr√©es par voyages s√©lectionn√©s
  let pinsData = [];
  // construire l'ensemble des villes autoris√©es par les voyages s√©lectionn√©s
  const allowedCities = new Set();
  if(s.activeVoyages && s.activeVoyages.size){
    s.activeVoyages.forEach(v => {
      const list = voyagesToCities[v];
      if(Array.isArray(list)) list.forEach(city => allowedCities.add(city));
    });
  }
  if(allowedCities.size > 0){
    pinsData = visitedCities.filter(c => allowedCities.has(c.name));
  } else {
    // si aucune ville autoris√©e (aucun voyage coch√©), ne pas afficher de pins
    pinsData = [];
  }
series.push({
  name: 'Pins',
  type: 'scatter3D',
  coordinateSystem: 'globe',
  symbol: 'circle',
  symbolSize: 10,
  itemStyle: {
    color: '#FFFFFF',
    borderColor: '#000000',
    borderWidth: 0.75,
  },
  emphasis: {
    itemStyle: {
      color: '#FFD700', // Couleur au survol
      borderColor: '#000000',
      borderWidth: 1, // Contour l√©g√®rement plus √©pais au survol
    },
    label: {
      show: true,
      formatter: p => p.name,
      position: 'top',
      textStyle: {
        color: '#fff',
        padding: [2, 2],
        borderRadius: 3,
        backgroundColor: 'rgba(0,0,0,1)',
        fontSize: 15, // Optionnel : agrandir le texte au survol
      }
    }
  },
  data: pinsData
});

  const layers = [];
  if(!s.isNight){ layers.push({ show: true, name: 'Ombre nuit', type: 'blend', intensity: 1, blendTo: 'emission', texture: PATH_EARTH_NIGHT_RAW }); }
  if(s.isNight){ layers.push({ show: true, name: 'Ombre nuit', type: 'blend', intensity: 1.3, blendTo: 'emission', texture: PATH_EARTH_NIGHT_RAW }); }
  if(s.showNuages){ layers.push({ show: true, name: 'Nuages', type: 'overlay', texture: CLOUDS, shading: 'lambert', distance: 2 }); }
  const baseDay = (s.dayBase === 'earth') ? PATH_EARTH_DAY_1 : PATH_EARTH_DAY_2;
  return {
    backgroundColor: 'transparent',
    globe: {
      baseTexture: s.isNight ? nightTexture : baseDay,
      heightTexture: s.showRelief ? PATH_EARTH_BUMP : undefined,
      displacementScale: 0.025,
      shading: s.isNight ? 'lambert' : 'realistic',
      environment: PATH_STARFIELD,
      postEffect: { enable: false },
      light: {
        ambient: { color: '#1f1f1f', intensity: 0.2 },
        main: { color: '#FFFDED', intensity: s.isNight ? -20 : 0.9 }
      },
      atmosphere: { show: true, color: '#a1a1a1', offset: 4 },
      viewControl: { autoRotate: false, autoRotateSpeed: 0.5 },
      layers
    },
    series
  };
}


function getCurrentView() {
  const opt = globeChart.getOption();
  if(opt && opt.globe && opt.globe[0] && opt.globe[0].viewControl){
    return { ...opt.globe[0].viewControl };
  }
  return null;
}

function refresh(){
  const currentView = getCurrentView();
  const newOpt = makeOption(state);
  if(currentView) {
    newOpt.globe.viewControl = { ...newOpt.globe.viewControl, ...currentView };
  }
  globeChart.setOption(newOpt, { notMerge:true });
}


  // --- UI refs ---
  const toggleEl = document.getElementById('toggle');
  const toggleReliefEl = document.getElementById('toggleRelief');
  const toggleCloudsEl = document.getElementById('toggleClouds');
  const toggleDayBaseEl = document.getElementById('toggleDayBase');
  const chkPays = document.getElementById('chkPays');
  const chkTrajets = document.getElementById('chkTrajets');
  const popupEl = document.getElementById('trajetPopup');
  const leafletPopupEl = document.getElementById('leafletPopup');
  const leafletMapEl = document.getElementById('leafletMap');
  const leafletCloseBtn = document.getElementById('leafletClose');
  const voyagesListEl = document.getElementById('voyagesList');       // AJOUT

  // Remplit la liste avec les valeurs uniques de `voyage`
  Array.from(voyagesSet).sort().forEach(v => {
    const id = 'voy_'+v.replace(/[^A-Za-z0-9_-]/g,'_');
    const label = document.createElement('label');
    label.setAttribute('for', id);
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = id;
    cb.className = 'voyageChk';
    cb.value = v;
    cb.checked = true;
    cb.setAttribute('aria-label', 'Voyage '+v);
    label.appendChild(cb);
    label.appendChild(document.createTextNode(' '+v));
    voyagesListEl.appendChild(label);
  });

  // --- √©v√©nements ---
  toggleEl.addEventListener('click', ()=>{
    state.isNight = !state.isNight;
    toggleEl.classList.toggle('night', state.isNight);
    toggleEl.setAttribute('aria-pressed', String(state.isNight));
    refresh();
  });

  toggleReliefEl.addEventListener('click', ()=>{
    state.showRelief = !state.showRelief;
    toggleReliefEl.classList.toggle('active', state.showRelief);
    toggleReliefEl.setAttribute('aria-pressed', String(state.showRelief));
    refresh();
  });

  toggleCloudsEl.addEventListener('click', ()=>{
    state.showNuages = !state.showNuages;
    toggleCloudsEl.classList.toggle('active', state.showNuages);
    toggleCloudsEl.setAttribute('aria-pressed', String(state.showNuages));
    refresh();
  });
  
  function updateDayBaseButtonLabel(){
    toggleDayBaseEl.textContent = (state.dayBase === 'earth') ? 'EARTH' : 'TOPO';
  }
  toggleDayBaseEl.addEventListener('click', ()=>{
    state.dayBase = (state.dayBase === 'earth') ? 'topo' : 'earth';
    updateDayBaseButtonLabel();
    refresh();
  });
  updateDayBaseButtonLabel();
  
  [['Pays', chkPays], ['Trajets', chkTrajets]].forEach(([name, el])=>{
    el.addEventListener('change', e=>{
      state['show'+name] = e.target.checked;
      if(name === 'Trajets'){
        voyagesListEl.style.display = state.showTrajets ? 'block' : 'none'; // affiche/masque la liste quand "Trajets" est coch√©
      }
      refresh();
    });
  });

  // Gestion des cases des voyages
  voyagesListEl.addEventListener('change', (e)=>{
    const t = e.target;
    if(t && t.classList.contains('voyageChk')){
      if(t.checked) state.activeVoyages.add(t.value);
      else state.activeVoyages.delete(t.value);
      refresh();
    }
  });

  // Leaflet popup helpers
  let currentLeafletMap = null;
  function openLeafletPopup(cityData){
    leafletPopupEl.style.display = 'block';

    // (R√©)initialiser la carte
    if(currentLeafletMap){
      currentLeafletMap.remove();
      currentLeafletMap = null;
    }
    leafletMapEl.innerHTML = '';

    // Fonds de carte
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
    });
    const googleStreet = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
      subdomains:['mt0','mt1','mt2','mt3'],
      attribution: '¬© Google'
    });
    const googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      subdomains:['mt0','mt1','mt2','mt3'],
      attribution: '¬© Google'
    });    
    const [lon, lat] = cityData.value;
    currentLeafletMap = L.map(leafletMapEl).setView([lat, lon], 13);
    osm.addTo(currentLeafletMap);

    const baseMaps = {
      "OpenStreetMap": osm,
      "Google Street": googleStreet,
      "Google Satellite": googleSat,
    };

L.control.layers(baseMaps).addTo(currentLeafletMap);
    
    (cityData.visites || []).forEach(v => {
      const [vlon, vlat] = v.coords;
    
      if(v.type === 'hotel'){
        L.marker([vlat, vlon], { icon: hotelIcon }).addTo(currentLeafletMap)
          .bindPopup(`<b>Hotel</b>`);
      } else {
        L.marker([vlat, vlon]).addTo(currentLeafletMap)
          .bindPopup(`<b>${v.name || ''}</b><br>${v.photo ? `<img src="${v.photo}" width="250"/>` : ''}`);
      }
    });
    setTimeout(()=>{ currentLeafletMap.invalidateSize(); }, 50);
  }
  
  function closeLeafletPopup(){
    leafletPopupEl.style.display = 'none';
    if(currentLeafletMap){ currentLeafletMap.remove(); currentLeafletMap = null; }
  }
  leafletCloseBtn.addEventListener('click', closeLeafletPopup);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeLeafletPopup(); });
  leafletPopupEl.addEventListener('click', (e)=>{ if(e.target === leafletPopupEl) closeLeafletPopup(); });

  // clic sur globe
  globeChart.on('click', params => {
    if(params.seriesName === 'Trajets' && params.data && params.data.properties){
      const p = params.data.properties;
      const popupEl = document.getElementById('trajetPopup');
      popupEl.innerHTML = `
        <strong>Trajet:</strong> ${p.trajet || ''}<br/>
        <strong>Voyage:</strong> ${p.voyage || ''}<br/>
        <strong>Date d√©but:</strong> ${p.date_deb || ''}<br/>
        <strong>Date fin:</strong> ${p.date_fin || ''}<br/>
        <strong>Dur√©e:</strong> ${p.duree || ''}<br/>
        <strong>Distance:</strong> ${p.distanceKM || ''} km
      `;
      popupEl.style.display = 'block';
    } else if(params.seriesName === 'Pins' && params.data){
      const popupEl = document.getElementById('trajetPopup');
      popupEl.style.display = 'none';
      openLeafletPopup(params.data);
    } else {
      const popupEl = document.getElementById('trajetPopup');
      popupEl.style.display = 'none';
    }
  });

  // rendu initial
  // afficher la liste des voyages si "Trajets" est coch√© au d√©part
  voyagesListEl.style.display = state.showTrajets ? 'block' : 'none';
  refresh();

})();
</script>
</body>
</html>
